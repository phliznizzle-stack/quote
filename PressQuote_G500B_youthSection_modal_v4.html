
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pigmacast Studio's PressQuote Pro — Master Build (v3.9.12)</title>
<style>
  :root{--bg:#0f1318;--panel:#151b22;--muted:#7c8a99;--text:#e8eef6;--accent:#ff7aa2;--line:#202a35;--gap:clamp(12px,1.6vw,18px);--radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:clamp(13px,1.2vw,15px)/1.55 system-ui,Segoe UI,Roboto,Arial}
  h1{font-size:clamp(18px,2vw,22px);margin:0} .sub{color:var(--muted);font-size:clamp(11px,1vw,12px)}
  .wrap{max-width:min(1400px,96vw);margin:clamp(12px,2.5vw,24px) auto;padding:0 clamp(8px,2vw,16px)}
  .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:var(--gap)}
  .btn{background:var(--accent);border:none;color:#0b0f14;padding:.66em .9em;border-radius:12px;cursor:pointer;font-weight:700;white-space:nowrap;
       transition:background-color .12s ease,filter .12s ease,box-shadow .12s ease,transform .05s ease}
  .btn:hover{filter:brightness(1.08)}
  .btn:active{filter:brightness(0.92);box-shadow:inset 0 2px 6px rgba(0,0,0,.45);transform:translateY(1px)}
  .btn.ghost{background:transparent;color:#fff;border:1px solid var(--line)}
  .btn.ghost:hover{background:rgba(255,255,255,.04);border-color:#2a3644;filter:none}
  .btn.ghost:active{background:rgba(255,255,255,.06);box-shadow:inset 0 2px 6px rgba(0,0,0,.45);transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(280px,420px);gap:var(--gap);align-items:start}
  @media (max-width:980px){.grid{grid-template-columns:1fr}.sticky{position:static}}
  .stack{display:grid;gap:var(--gap)} .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:clamp(12px,1.8vw,18px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0} .row.between{justify-content:space-between}
  label{color:var(--muted)}
  input[type=number],select{padding:.6em .7em;background:#0c1015;color:#e8eef6;border:1px solid var(--line);border-radius:10px}
  input[type=number]{width:clamp(80px,12ch,110px)}
  input[type=text]{padding:.55em .7em;background:#0c1015;color:#e8eef6;border:1px solid var(--line);border-radius:10px;width:100%}
  .sizes{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px}
  .sizes .box{display:flex;flex-direction:column;gap:6px}
  .sizes .box small{color:var(--muted)}
  .garment-line{border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse;font-size:clamp(12px,1vw,14px)}
  th,td{padding:.55em;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:var(--muted);font-weight:600;text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)}
  .toggle{display:flex;gap:8px;align-items:center}
  .sheet-row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .mini{width:clamp(70px,8ch,90px)}
  .tt{position:relative;display:inline-block;border-bottom:1px dotted var(--line)}
  .tt .ttc{visibility:hidden;opacity:0;transition:.15s;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);background:#0c1015;border:1px solid var(--line);color:#e8eef6;padding:8px 10px;border-radius:8px;min-width:220px;max-width:min(380px,88vw);box-shadow:0 2px 8px rgba(0,0,0,.35);white-space:normal}
  .tt:hover .ttc{visibility:visible;opacity:1}
  .sticky{position:sticky;top:clamp(8px,2vw,14px)}
  .section-title{font-weight:700;margin-bottom:.25rem}

  /* Costs & Settings grid */
  .cs-grid{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px}
  @media (max-width:1100px){.cs-grid{grid-template-columns:repeat(3,minmax(180px,1fr))}}
  @media (max-width:820px){.cs-grid{grid-template-columns:repeat(2,minmax(180px,1fr))}}
  @media (max-width:560px){.cs-grid{grid-template-columns:1fr}}
  .cs-item{display:flex;flex-direction:column;gap:8px;background:#121923;border:1px solid var(--line);border-radius:12px;padding:12px;min-height:110px}
  .cs-item label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .cs-sub{font-size:11px;color:var(--muted);line-height:1.35}
  .cs-inline{display:flex;align-items:center;gap:8px}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
  .modal.active{display:flex}
  .modal .sheet{background:var(--panel);border:1px solid var(--line);border-radius:16px;max-width:min(1280px,96vw);max-height:90vh;overflow:auto;padding:16px}
  .price-wrap{min-width:920px}
  .price-grid{display:grid;grid-template-columns:110px minmax(340px,3.2fr) 0.8fr repeat(8, 80px);gap:10px;align-items:center}
  .price-grid .hdr{color:var(--muted);font-weight:700;text-align:center}
  .price-grid input{width:100%} .price-grid input[data-size]{text-align:right} .sku{max-width:120px}
  .sticky-sizes{position:sticky;top:0;background:var(--panel);padding:6px 0;border-bottom:1px solid var(--line);z-index:2}
  .gname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row-dim{opacity:.45;filter:grayscale(.2)}
  .sku-inline{display:flex;gap:8px;align-items:center}
  .sku-inline .sku{max-width:110px}
  .inline-actions{display:flex;gap:8px;align-items:center}
</style>

<style id="modal-top-patch">
/* Only show modals when active (or aria-hidden=false). Keep them at top. */
.modal, #exportModal, [role="dialog"] {
  /* do NOT force display here */
  align-items: flex-start !important;
  justify-content: center !important;
  padding-top: 16px !important;
}
/* Explicitly control visibility state */
.modal.active, #exportModal.active, [role="dialog"][aria-hidden="false"] {
  display: flex !important;
}
.modal:not(.active), #exportModal:not(.active), [role="dialog"][aria-hidden="true"] {
  display: none !important;
}
/* Keep panel/content at top (no center transforms) */
.modal .modal-panel,
.modal .panel,
.modal .card,
.modal .dialog,
#exportModal .modal-panel,
#exportModal .panel,
#exportModal .card,
[role="dialog"] .modal-panel,
[role="dialog"] .panel,
[role="dialog"] .card {
  position: relative !important;
  top: 0 !important;
  transform: none !important;
  margin-top: 0 !important;
}
/* Overlay can scroll if content is tall */
.modal, #exportModal, [role="dialog"] {
  overflow: auto !important;
}
</style>


<style id="pqp-scrim-styles">
  :root{ --pqp-scrim-h: 360px; }
  #pqpScrim {
    position: fixed; left: 0; right: 0; bottom: 0;
    height: var(--pqp-scrim-h);
    background: var(--bg, #0f1318);
    pointer-events: none;
    z-index: 2147483000;
    display: none;
  }
  #pqpScrimBtn {
    position: fixed; right: 10px; top: 12px;
    z-index: 2147483001;
    background: var(--panel, #151b22);
    color: var(--text, #e8eef6);
    border: 1px solid var(--line, #202a35);
    border-radius: 10px;
    padding: 6px 10px;
    font: 12px/1.2 system-ui, Segoe UI, Roboto, Arial;
    box-shadow: 0 2px 12px rgba(0,0,0,.35);
    cursor: pointer;
    opacity: .85;
  }
  #pqpScrimBtn:hover{ opacity: 1; }
  #pqpScrimPanel {
    position: fixed; right: 10px; top: 56px;
    z-index: 2147483002;
    background: var(--panel, #151b22);
    color: var(--text, #e8eef6);
    border: 1px solid var(--line, #202a35);
    border-radius: 12px;
    padding: 10px 12px;
    font: 12px/1.2 system-ui, Segoe UI, Roboto, Arial;
    display: none;
    min-width: 220px;
  }
  #pqpScrimPanel label{ display:block; margin-bottom: 8px; color: var(--muted,#7c8a99);}
  #pqpScrimPanel input[type="range"]{ width: 100%; }
  #pqpScrimPanel .row{ display:flex; align-items:center; gap:8px; margin-top:6px;}
  #pqpScrimPanel .row input[type="number"]{
    width: 84px; background: transparent; color: var(--text,#e8eef6);
    border: 1px solid var(--line,#202a35); border-radius: 8px; padding: 4px 6px;
  }
  #pqpScrimPanel .row button{
    background: var(--panel,#151b22); color: var(--text,#e8eef6);
    border: 1px solid var(--line,#202a35); border-radius: 8px; padding: 4px 8px; cursor:pointer;
  }
</style>

</head>
<body>
<script>window.PQP_LOGO_B64="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";</script>
  <div class="wrap">
    <div class="bar">
      <div>
        <h1>Pigmacast Studio's PressQuote Pro <span class="sub">Master Build v3.9.14 (Export)</span></h1>
        <div class="sub"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="editBtn">Edit Garment Prices</button>
<button class="btn" id="exportBtn" type="button" onclick="(function(){var m=document.getElementById('exportModal'); if(m) m.classList.add('active'); })()">Export Quote (PDF)</button>
<button class="btn ghost" id="resetBtn">Reset Prices</button>
      </div>
    </div>

    <!-- MAIN APP (same as v3.9.10) -->
    <div class="grid">
      <div class="stack">
        <div class="card">
          <div class="row between">
            <div class="section-title">Garments</div>
            <div class="row" style="gap:8px">
    <button class="btn ghost" id="youthChartBtn" type="button">Youth Size Chart</button>
    <button class="btn ghost" id="addLine">+ Add garment line</button>
  </div>
          </div>
          <div id="garmentLines" class="muted">No garment lines yet. Click “+ Add garment line”.</div>
        </div>

        <div class="card">
          <div class="section-title">Placements &amp; Sizes</div>
          <div class="row">
            <label class="toggle"><input type="checkbox" id="pl_left" /> Left chest</label>
            <input type="number" class="mini" id="pl_left_w" placeholder="W (in)" min="0" step="0.1" />
            <input type="number" class="mini" id="pl_left_h" placeholder="H (in)" min="0" step="0.1" />
          </div>
          <div class="row">
            <label class="toggle"><input type="checkbox" id="pl_front" /> Full front</label>
            <input type="number" class="mini" id="pl_front_w" placeholder="W (in)" min="0" step="0.1" />
            <input type="number" class="mini" id="pl_front_h" placeholder="H (in)" min="0" step="0.1" />
          </div>
          <div class="row">
            <label class="toggle"><input type="checkbox" id="pl_back" /> Full back</label>
            <input type="number" class="mini" id="pl_back_w" placeholder="W (in)" min="0" step="0.1" />
            <input type="number" class="mini" id="pl_back_h" placeholder="H (in)" min="0" step="0.1" />
          </div>
          <div class="row">
            <label class="toggle"><input type="checkbox" id="pl_sleeve" /> Sleeve</label>
            <input type="number" class="mini" id="pl_sleeve_w" placeholder="W (in)" min="0" step="0.1" />
            <input type="number" class="mini" id="pl_sleeve_h" placeholder="H (in)" min="0" step="0.1" />
          </div>
          <div class="row">
            <button class="btn ghost" id="clearSizes">Clear sizes</button>
            <span class="note">Clears W & H to 0 (checkboxes unchanged).</span>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Gang Sheet <span class="muted">(22″ width, 0.25″ gutters)</span></div>
          <div class="row">
            <div class="pill">Required length: <span id="reqLen">0.00</span> ft</div>
            <div class="pill">Purchased length: <span id="bestPreset">—</span></div>
            <div class="pill">Utilization: <span id="util">0%</span></div>
          </div>
          <div class="row" style="gap:16px;align-items:flex-end">
            <div class="cs-inline">
              <label class="toggle" style="gap:6px"><input type="checkbox" id="manualPlan" /> Manual override</label>
            </div>
            <div class="cs-inline">
              <label style="color:var(--muted)">Auto mode</label>
              <select id="autoMode">
                <option value="standard">Standard (bump last sheet)</option>
                <option value="optimize">Optimize cost (aim ≥75% util)</option>
              </select>
            </div>
            <div class="cs-inline" id="threshStack">
              <label style="color:var(--muted)">Bump threshold %</label>
              <input type="number" id="bumpThresh" value="85" min="50" max="95" step="1" />
            </div>
          </div>
          <div id="sheets"></div>
          <div class="row">
            <button class="btn ghost" id="addSheet" disabled>+ Add sheet</button>
            <button class="btn ghost" id="removeSheet" disabled>Remove last sheet</button>
          </div>
          <div class="row">
            <label>Quick set (total length):</label>
            <select id="quickTotal" disabled><option value="">— choose —</option></select>
            <span class="note">Composes from 2/5/7/10/15/20/30 ft presets.</span>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Costs &amp; Settings</div>
          <div class="cs-grid">
            <div class="cs-item">
              <label>Inbound shipping from Ninja ($)</label>
              <input type="number" id="inbound" value="0" min="0" step="0.01" />
            </div>
            <div class="cs-item">
              <label>Labor rate ($/hr)</label>
              <input type="number" id="laborRate" value="25" min="0" step="0.25" />
            </div>
            <div class="cs-item">
              <label>Labor total ($)</label>
              <input type="number" id="laborTotal" value="0" min="0" step="0.25" />
              <div class="cs-sub">Suggested: <span id="laborSuggested">$0.00</span></div>
              <div class="cs-sub" id="laborExplain"></div>
            </div>
            <div class="cs-item">
              <label>Target margin %</label>
              <input type="number" id="margin" value="0" min="0" max="90" step="1" />
              <label class="toggle"><input type="checkbox" id="autoMargin" checked /> Auto margin by qty</label>
              <div class="cs-sub">Softer tiers: 1–11:35%, 12–23:33%, 24–49:31%, 50–99:29%, 100+:27%</div>
            </div>
          </div>
        </div>
      </div>

      <aside class="sticky">
        <div class="card">
          <div class="section-title">Totals</div>
          <table style="margin-top:8px">
            <tbody>
              <tr><td><div class="tt">Blanks<div class="ttc" id="tt_blanks">—</div></div></td><td class="right" id="blanksAmt">$0.00</td></tr>
              <tr><td><div class="tt">Gang sheets<div class="ttc" id="tt_gang">—</div></div></td><td class="right" id="gangAmt">$0.00</td></tr>
              <tr><td><div class="tt">Raw materials (blanks + gang)<div class="ttc" id="tt_raw">—</div></div></td><td class="right" id="rawAmt">$0.00</td></tr>
              <tr><td><div class="tt">Inbound shipping (Ninja)<div class="ttc" id="tt_inbound">—</div></div></td><td class="right" id="inboundAmt">$0.00</td></tr>
              <tr><td><div class="tt">Labor<div class="ttc" id="tt_labor">—</div></div></td><td class="right" id="laborAmt">$0.00</td></tr>
            </tbody>
            <tfoot>
              <tr><th><div class="tt">Subtotal (cost)<div class="ttc" id="tt_sub">—</div></div></th><th class="right" id="subAmt">$0.00</th></tr>
              <tr><th><div class="tt">Client total (rounded)<div class="ttc" id="tt_client">—</div></div></th><th class="right" id="clientAmt">$0.00</th></tr>
              <tr><td class="muted">Per-shirt</td><td class="right" id="perAmt">$0.00</td></tr>
              <tr><td class="muted">Total units</td><td class="right" id="unitsAmt">0</td></tr>
            </tfoot>
          </table>
          <div class="sub cs-sub" id="pricingCheck" style="margin-top:.5rem;line-height:1.4"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Edit Prices Modal -->
  <div class="modal" id="priceModal" aria-hidden="true">
    <div class="sheet">
      <div class="row between" style="margin-bottom:12px">
        <div><strong>Edit Garment Prices</strong> <span class="sub">Changes are saved locally</span></div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="closeModal">Close</button>
          <button class="btn" id="savePrices">Save</button>
        </div>
      </div>

      <div class="price-wrap">
        <div class="row between" style="margin:6px 0 8px 0">
          <div class="sub">Edit name, SKU, and size prices. Delete hides an item without losing past entries.</div>
          <button class="btn ghost" id="addProduct">+ Add garment</button>
        </div>
        <div class="price-grid sticky-sizes">
          <div class="hdr" style="text-align:left;padding-left:6px">Garment</div>
          <div class="hdr">Name</div>
          <div class="hdr">SKU</div>
          <div class="hdr">S</div><div class="hdr">M</div><div class="hdr">L</div><div class="hdr">XL</div>
          <div class="hdr">2XL</div><div class="hdr">3XL</div><div class="hdr">4XL</div><div class="hdr">5XL</div>
        </div>
        <div id="priceEditor"></div>
      </div>
    </div>
  </div>

<script>
if(!window.__pigmacastV3911){ window.__pigmacastV3911 = true;

const BAKED_NINJA = { "garments": [
  {"name":"Gildan G500 Adult Heavy Cotton T-Shirt | 5.3 oz.","sku":"G500","size_prices":{"S":2.35,"M":2.35,"L":2.35,"XL":4.65,"2XL":5.87,"3XL":6.17,"4XL":6.17,"5XL":6.17}},
  {"name":"Hanes 5280 Unisex Comfortsoft Cotton T-Shirt - Affordable Quality","sku":"5280","size_prices":{"S":2.62,"M":2.62,"L":2.62,"XL":4.76,"2XL":6.37,"3XL":6.37,"4XL":6.37,"5XL":6.37}},
  {"name":"Gildan G840 Adult 50/50 Long-Sleeve T-Shirt","sku":"G840","size_prices":{"S":8.48,"M":8.48,"L":8.48,"XL":9.55,"2XL":12.21,"3XL":12.21}},
  {"name":"Gildan G185 Hooded Sweatshirt - Adult Heavy Blend 50/50","sku":"G185","size_prices":{"S":10.93,"M":10.93,"L":10.93,"XL":16.66,"2XL":18.27,"3XL":18.27,"4XL":18.27,"5XL":18.27}}
,
  {"name":"Gildan G500B Youth Heavy Cotton T-Shirt","sku":"G500B","size_prices":{"XS":2.48,"S":2.48,"M":2.48,"L":2.48,"XL":2.48}}
]};
const PR_SHEETS=[{ft:2,price:19.99},{ft:5,price:49.99},{ft:7,price:69.99},{ft:10,price:89.99},{ft:15,price:109.99},{ft:20,price:129.99},{ft:30,price:179.99}];
const PRESETS = PR_SHEETS.map(s=>s.ft).sort((a,b)=>a-b);
const GUTTER=0.25, ROLL_WIDTH=22;
const LS_KEY="ninja_prices_overrides_v2"; // bump schema

function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function loadOverrides(){ return JSON.parse(localStorage.getItem(LS_KEY) || '{"garments":[]}'); }
function saveOverrides(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

function loadPricing(){
  const ov=loadOverrides(); const merged=deepClone(BAKED_NINJA); const deleted=new Set((ov.garments||[]).filter(g=>g.is_deleted).map(g=>g.sku));
  // First, update baked with overrides
  for(const g of (ov.garments||[])){
    const idx=merged.garments.findIndex(x=>x.sku===g.sku);
    if(idx>=0){
      if(g.is_deleted){ merged.garments.splice(idx,1); continue; }
      merged.garments[idx].name = g.name || merged.garments[idx].name;
      merged.garments[idx].size_prices = {...merged.garments[idx].size_prices, ...g.size_prices};
    }
  }
  // Then, add any brand-new garments from overrides (not in baked & not deleted)
  for(const g of (ov.garments||[])){
    const exists=merged.garments.some(x=>x.sku===g.sku);
    if(!exists && !g.is_deleted){ merged.garments.push({ name: g.name||g.sku, sku: g.sku, size_prices: {...g.size_prices} }); }
  }
  // Filter any baked removed via overrides
  merged.garments = merged.garments.filter(g=>!deleted.has(g.sku));
  return merged;
}
let PRICING=loadPricing();

const garmentLines=document.getElementById("garmentLines");
const priceModal=document.getElementById("priceModal");
const priceEditor=document.getElementById("priceEditor");

function sizeKeysForSKU(sku){ const g=PRICING.garments.find(x=>x.sku===sku) || PRICING.garments[0]; return Object.keys(g.size_prices); }
function priceFor(sku,sz){ const g=PRICING.garments.find(x=>x.sku===sku); return g?.size_prices?.[sz]||0; }
function fmt(n){ return "$"+(n).toFixed(2); }
function roundToQuarter(n){ return Math.round(n*4)/4; }

let lineCounter=0;
function addGarmentLine(initialSku){
  if(garmentLines.classList.contains("muted")){ garmentLines.classList.remove("muted"); garmentLines.textContent=""; }
  const id="line_"+(lineCounter++);
  const div=document.createElement("div"); div.className="garment-line"; div.dataset.line=id;
  const header=document.createElement("div"); header.className="row between";
  const sel=document.createElement("select"); sel.className="garmentSel";
  const blank=document.createElement("option"); blank.value=""; blank.textContent="— choose garment —"; sel.appendChild(blank);
  for(const g of PRICING.garments){ const opt=document.createElement("option"); opt.value=g.sku; opt.textContent=`${g.name} (${g.sku})`; sel.appendChild(opt); }
  if(initialSku) sel.value=initialSku;
  const removeBtn=document.createElement("button"); removeBtn.className="btn ghost"; removeBtn.textContent="Remove"; removeBtn.onclick=()=>{ div.remove(); recalcAll(); };
  header.appendChild(sel); header.appendChild(removeBtn);
  const sizes=document.createElement("div"); sizes.className="sizes";
  function buildSizeInputs(){
    sizes.innerHTML="";
    if(!sel.value){ const note=document.createElement("div"); note.className="muted"; note.textContent="Select a garment to enter sizes."; sizes.appendChild(note); recalcAll(); return; }
    const keys=sizeKeysForSKU(sel.value);
    for(const k of keys){
      const box=document.createElement("div"); box.className="box";
      const lab=document.createElement("div"); lab.innerHTML=`<strong>${k}</strong> <small>($${priceFor(sel.value,k).toFixed(2)})</small>`;
      const inp=document.createElement("input"); inp.type="number"; inp.min="0"; inp.step="1"; inp.value="0"; inp.className="qty"; inp.dataset.size=k;
      box.appendChild(lab); box.appendChild(inp); sizes.appendChild(box);
    }
    recalcAll();
  }
  buildSizeInputs(); sel.addEventListener("change", buildSizeInputs); sizes.addEventListener("input", recalcAll);
  div.appendChild(header); div.appendChild(sizes); garmentLines.appendChild(div); recalcAll();
}

// Placements and calc functions unchanged from v3.9.10
function placements(){ const list=[];
  function grab(idb,name){ const on=document.getElementById(idb).checked;
    const w=parseFloat(document.getElementById(idb+"_w").value||"0");
    const h=parseFloat(document.getElementById(idb+"_h").value||"0");
    if(on && w>0 && h>0) list.push({name,w,h}); }
  grab("pl_left","Left chest"); grab("pl_front","Full front"); grab("pl_back","Full back"); grab("pl_sleeve","Sleeve");
  return list;
}
document.getElementById("clearSizes").addEventListener("click", ()=>{
  ["pl_left_w","pl_left_h","pl_front_w","pl_front_h","pl_back_w","pl_back_h","pl_sleeve_w","pl_sleeve_h"].forEach(id=>document.getElementById(id).value="");
  recalcAll();
});

function totalQty(){ let q=0;
  for(const line of garmentLines.querySelectorAll(".garment-line")){
    const sku=line.querySelector(".garmentSel").value; if(!sku) continue;
    for(const inp of line.querySelectorAll(".qty")){ const n=parseInt(inp.value||"0"); if(n>0) q+=n; }
  }
  return q;
}
function blanksCost(){ let cost=0; const lines=[];
  for(const line of garmentLines.querySelectorAll(".garment-line")){
    const sku=line.querySelector(".garmentSel").value; if(!sku) continue; let lineSum=0; const parts=[]; let units=0;
    for(const inp of line.querySelectorAll(".qty")){
      const size=inp.dataset.size; const n=parseInt(inp.value||"0"); const price=priceFor(sku,size);
      if(n>0){ const add=n*price; lineSum+=add; units+=n; parts.push(`${size}×${n}@$${price.toFixed(2)}`); }
    }
    if(lineSum>0){ cost+=lineSum; lines.push(`${sku}: ${parts.join(" + ")} = $${lineSum.toFixed(2)} (${units} units)`); }
  }
  document.getElementById("tt_blanks").textContent = lines.length? lines.join(" • ") : "—";
  return cost;
}

const GUTTER_CONST=0.25, ROLL_WIDTH_CONST=22;
function bestColumnsFor(w,h){
  const wA=w+GUTTER_CONST, hA=h+GUTTER_CONST, wB=h+GUTTER_CONST, hB=w+GUTTER_CONST;
  const colsA=Math.max(1,Math.floor((ROLL_WIDTH_CONST+GUTTER_CONST)/wA));
  const colsB=Math.max(1,Math.floor((ROLL_WIDTH_CONST+GUTTER_CONST)/wB));
  return (colsB>colsA)? {cols:colsB,rowHeight:hB,rotated:true}:{cols:colsA,rowHeight:hA,rotated:false};
}
function requiredLengthFeet(){
  const list=placements(); const qty=totalQty(); if(qty===0 || list.length===0) return 0;
  let inches=0; const details=[];
  for(const p of list){
    const fit=bestColumnsFor(p.w,p.h); const perRow=fit.cols; const rows=Math.ceil(qty/perRow); const add=rows*fit.rowHeight;
    inches+=add; details.push(`${p.name}: ${rows} rows × ${perRow}/row${fit.rotated?' (rotated)':''}`);
  }
  inches=Math.max(0,inches-GUTTER_CONST);
  document.getElementById("tt_gang").textContent = details.length? details.join(" • ") : "—";
  return inches/12.0;
}

function costOfPlan(plan){ return plan.reduce((s,ft)=> s + (PR_SHEETS.find(p=>p.ft===ft)?.price||0), 0); }
function standardPlan(lenFt,bump){ if(lenFt<=0) return []; const choices=PRESETS; const plan=[]; let remaining=lenFt;
  while(remaining>0){ if(remaining>choices[choices.length-1]){ plan.push(choices[choices.length-1]); remaining-=choices[choices.length-1]; }
    else { const pick=choices.find(x=>x>=remaining) ?? choices[choices.length-1]; plan.push(pick); remaining=0; } if(plan.length>100) break; }
  if(plan.length){ const usedOnLast=lenFt-(plan.slice(0,-1).reduce((a,b)=>a+b,0)); let last=plan[plan.length-1]; const idx=choices.indexOf(last); const util=usedOnLast/last;
    if(util>bump/100 && idx<choices.length-1){ plan[plan.length-1]=choices[idx+1]; } else if(util>bump/100 && last===choices[choices.length-1]){ plan.push(choices[0]); } }
  return plan; }
function optimizePlan(lenFt,minUtil=0.75){ if(lenFt<=0) return []; const choices=PRESETS; let best=null,bestAny=null;
  function dfs(start,current,total){ if(total>=lenFt){ const util=lenFt/total; const cost=costOfPlan(current);
      if(util>=minUtil){ if(!best || cost<best.cost || (cost===best.cost && total<best.total)) best={plan:current.slice(),total,cost,util}; }
      if(!bestAny || cost<bestAny.cost || (cost===bestAny.cost && total<bestAny.total)) bestAny={plan:current.slice(),total,cost,util}; return; }
    if(current.length>=5) return; for(let i=start;i<choices.length;i++){ current.push(choices[i]); dfs(i,current,total+choices[i]); current.pop(); } }
  dfs(0,[],0); return (best? best.plan : bestAny.plan); }

function sheetsUIUpdate(plan){
  const cont=document.getElementById("sheets"); cont.innerHTML="";
  for(let i=0;i<plan.length;i++){
    const row=document.createElement("div"); row.className="sheet-row";
    const label=document.createElement("div"); label.textContent=`Sheet ${i+1}:`;
    const sel=document.createElement("select"); sel.className="sheetSel";
    for(const p of PR_SHEETS){ const opt=document.createElement("option"); opt.value=p.ft; opt.textContent=`${p.ft} ft — $${p.price.toFixed(2)}`; sel.appendChild(opt); }
    sel.value=plan[i]; sel.addEventListener("change", recalcAll);
    row.appendChild(label); row.appendChild(sel); cont.appendChild(row);
  }
}

(function(){
  const qt=document.getElementById("quickTotal");
  [2,5,7,10,15,20,30].forEach(ft=>{ const opt=document.createElement("option"); opt.value=ft; opt.textContent=`${ft} ft`; qt.appendChild(opt); });
  qt.addEventListener("change", ()=>{
    const v=Number(qt.value||0); if(!v) return;
    const sizes=[30,20,15,10,7,5,2]; let remaining=v; const plan=[];
    for(const s of sizes){ while(remaining>=s){ plan.push(s); remaining-=s; } }
    if(remaining>0) plan.push(2);
    document.getElementById("manualPlan").checked=true;
    document.getElementById("addSheet").disabled=false;
    document.getElementById("removeSheet").disabled=false;
    sheetsUIUpdate(plan); recalcAll();
  });
})();

function autoMarginForQty(q){ if(q>=100) return 27; if(q>=50) return 29; if(q>=24) return 31; if(q>=12) return 33; if(q>=1) return 35; return 0; }

let laborLocked=false;

function recalcAll(){
  const mode=document.getElementById("autoMode").value;
  document.getElementById("threshStack").style.display=(mode==="standard")?"":"none";

  const req=requiredLengthFeet(); document.getElementById("reqLen").textContent=req.toFixed(2);

  const manual=document.getElementById("manualPlan").checked;
  document.getElementById("addSheet").disabled=!manual;
  document.getElementById("removeSheet").disabled=!manual;
  document.getElementById("quickTotal").disabled=!manual;

  let purchased=0, gang=0, plan=[];
  if(manual){
    for(const sel of document.querySelectorAll(".sheetSel")){ const v=Number(sel.value||0); purchased+=v; gang += (PR_SHEETS.find(p=>p.ft===v)?.price||0); plan.push(v); }
  } else {
    if(mode==="optimize"){ plan=optimizePlan(req,0.75); }
    else { const t=parseFloat(document.getElementById("bumpThresh").value||"85"); plan=standardPlan(req,t); }
    sheetsUIUpdate(plan);
    purchased = plan.reduce((a,b)=>a+b,0);
    gang = plan.reduce((sum,ft)=> sum + (PR_SHEETS.find(p=>p.ft===ft)?.price||0), 0);
  }
  const util = purchased>0 ? Math.min(100, Math.max(0, (req/purchased)*100)) : 0;
  document.getElementById("bestPreset").textContent = purchased>0 ? `${purchased.toFixed(2)} ft (${plan.join("+")} ft)` : "—";
  document.getElementById("util").textContent = util.toFixed(0) + "%";

  const qty=totalQty();
  document.getElementById("unitsAmt").textContent=qty;

  const blanks=blanksCost();
  const raw = blanks + gang;
  document.getElementById("blanksAmt").textContent=fmt(blanks);
  document.getElementById("gangAmt").textContent=fmt(gang);
  document.getElementById("rawAmt").textContent=fmt(raw);
  document.getElementById("tt_raw").textContent=`Blanks $${blanks.toFixed(2)} + Gang $${gang.toFixed(2)} = $${raw.toFixed(2)}`;

  const inbound=parseFloat(document.getElementById("inbound").value||"0"); document.getElementById("inboundAmt").textContent=fmt(inbound);

  const rate=parseFloat(document.getElementById("laborRate").value||"25");
  const pCount=Math.max(1, placements().length);
  const baseThroughput=10; const pf=(pCount===1?1.0:pCount===2?1.5:pCount===3?2.0:2.5);
  const thr = baseThroughput / pf;
  const hours = (qty)/(thr>0?thr:1);
  const suggested = roundToQuarter(hours * rate);
  document.getElementById("laborSuggested").textContent = fmt(suggested);

  const laborInputEl = document.getElementById("laborTotal");
  if(!laborLocked){ laborInputEl.value = suggested.toFixed(2); }
  const expl = `At ${fmt(rate)}/hr × ${hours.toFixed(2)} hr ≈ ${fmt(suggested)} • placements: ${pCount}, effective throughput: ${thr.toFixed(2)}/hr`;
  document.getElementById("laborExplain").textContent = expl;

  const labor = roundToQuarter(Number(laborInputEl.value||"0"));
  document.getElementById("laborAmt").textContent=fmt(labor);
  document.getElementById("tt_labor").textContent = `${fmt(rate)}/hr × ${hours.toFixed(2)} hr = ${fmt(suggested)} • Entered: ${fmt(labor)} • placements ${pCount}, throughput ${thr.toFixed(2)}/hr`;

  const sub = raw + inbound + labor;
  document.getElementById("subAmt").textContent=fmt(sub);
  document.getElementById("tt_inbound").textContent=`Inbound shipping as entered: $${inbound.toFixed(2)}`;
  document.getElementById("tt_sub").textContent=`Raw $${raw.toFixed(2)} + Inbound $${inbound.toFixed(2)} + Labor $${labor.toFixed(2)}`;

  const auto=document.getElementById("autoMargin").checked;
  let margin=parseFloat(document.getElementById("margin").value||"0");
  if(auto){ margin=autoMarginForQty(qty); document.getElementById("margin").value=margin; document.getElementById("margin").disabled=true; }
  else { document.getElementById("margin").disabled=false; }
  const clientRaw=sub*(1+margin/100); const clientRounded=roundToQuarter(clientRaw);
  document.getElementById("clientAmt").textContent=fmt(clientRounded);
  document.getElementById("tt_client").textContent=`Subtotal $${sub.toFixed(2)} × (1 + ${margin.toFixed(0)}%) = $${clientRaw.toFixed(2)} → rounded to $${clientRounded.toFixed(2)}`;
  const per=qty>0 ? clientRounded/qty : 0; document.getElementById("perAmt").textContent=fmt(roundToQuarter(per));

  const gangPer=qty? gang/qty : 0; const blanksPer=qty? blanks/qty : 0; const inboundPer=qty? inbound/qty : 0; const laborPer=qty? labor/qty : 0;
  const basePer=blanksPer+gangPer+inboundPer+laborPer; const marginPer=(clientRounded - sub) / (qty||1);
  document.getElementById("pricingCheck").textContent=`Per-shirt → blanks ${fmt(blanksPer)} + gang ${fmt(gangPer)} + inbound ${fmt(inboundPer)} + labor ${fmt(laborPer)} = base ${fmt(basePer)} → margin adds ${fmt(marginPer)}.`;
}

// Wiring
function wireAll(){
  function replaceAndBind(id, handler, type="click"){
    const el=document.getElementById(id); if(!el) return;
    const fresh=el.cloneNode(true); el.parentNode.replaceChild(fresh, el);
    fresh.addEventListener(type, handler);
  }
  replaceAndBind("addLine", ()=> addGarmentLine(""));
  replaceAndBind("addSheet", ()=>{
    const cont=document.getElementById("sheets"); const row=document.createElement("div"); row.className="sheet-row"; row.innerHTML=`<div>Sheet ${cont.children.length+1}:</div>`;
    const sel=document.createElement("select"); sel.className="sheetSel"; for(const p of PR_SHEETS){ const opt=document.createElement("option"); opt.value=p.ft; opt.textContent=`${p.ft} ft — $${p.price.toFixed(2)}`; sel.appendChild(opt); }
    sel.value=7; sel.addEventListener("change", recalcAll); row.appendChild(sel); cont.appendChild(row); recalcAll();
  });
  replaceAndBind("removeSheet", ()=>{ const cont=document.getElementById("sheets"); if(cont.lastChild) cont.removeChild(cont.lastChild); recalcAll(); });

  const ids=["pl_left","pl_front","pl_back","pl_sleeve","pl_left_w","pl_left_h","pl_front_w","pl_front_h","pl_back_w","pl_back_h","pl_sleeve_w","pl_sleeve_h","manualPlan","inbound","laborRate","margin","autoMargin","autoMode","bumpThresh","quickTotal"];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener("input", recalcAll); el.addEventListener("change", recalcAll); } });
  document.getElementById("laborTotal").addEventListener("input", ()=>{ laborLocked=true; recalcAll(); });

  replaceAndBind("editBtn", openPrices);
  replaceAndBind("closeModal", ()=> priceModal.classList.remove("active"));
  replaceAndBind("savePrices", savePrices);
  replaceAndBind("resetBtn", ()=>{ localStorage.removeItem(LS_KEY); PRICING=loadPricing(); priceModal.classList.remove("active"); rebuildPriceEditor(); rebuildAllGarmentLabels(); recalcAll(); });

  replaceAndBind("addProduct", addProductRow);
}

function rebuildAllGarmentLabels(){
  for(const sel of document.querySelectorAll(".garmentSel")){
    const old=sel.value; sel.innerHTML="";
    const blank=document.createElement("option"); blank.value=""; blank.textContent="— choose garment —"; sel.appendChild(blank);
    for(const g of PRICING.garments){ const opt=document.createElement("option"); opt.value=g.sku; opt.textContent=`${g.name} (${g.sku})`; sel.appendChild(opt); }
    sel.value=old; sel.dispatchEvent(new Event('change'));
  }
}

// Modal rows
function addProductRow(prefill){
  const sizes=["S","M","L","XL","2XL","3XL","4XL","5XL"];
  const row=document.createElement("div"); row.className="price-grid"; row.dataset.sku=(prefill?.sku||"");
  const title=document.createElement("div"); // row title & actions
  title.innerHTML=`<div class="inline-actions">
    <button class="btn ghost btn-del" title="Delete">Delete</button>
  </div>`;
  const nameInp=document.createElement("input"); nameInp.type="text"; nameInp.placeholder="Garment name"; nameInp.value=prefill?.name||"";
  const skuInp=document.createElement("input"); skuInp.type="text"; skuInp.placeholder="SKU"; skuInp.className="sku"; skuInp.value=prefill?.sku||"";
  const nameCell=document.createElement("div"); nameCell.appendChild(nameInp);
  const skuCell=document.createElement("div"); skuCell.appendChild(skuInp);
  row.appendChild(title); row.appendChild(nameCell); row.appendChild(skuCell);
  for(const s of sizes){
    const inp=document.createElement("input"); inp.type="number"; inp.step="0.01"; inp.min="0"; inp.placeholder="—";
    if(prefill?.size_prices && prefill.size_prices[s]!=null) inp.value=prefill.size_prices[s];
    inp.dataset.size=s; row.appendChild(inp);
  }
  row.querySelector(".btn-del").addEventListener("click", ()=>{
    row.classList.toggle("row-dim");
    row.dataset.deleted = row.classList.contains("row-dim") ? "1" : "";
  });
  priceEditor.appendChild(row);
}

function openPrices(){
  rebuildPriceEditor(); priceModal.classList.add("active");
}
function rebuildPriceEditor(){
  priceEditor.innerHTML="";
  // existing garments
  for(const g of PRICING.garments){
    addProductRow(g);
  }
}
function savePrices(){
  const out={garments:[]};
  const seen=new Set();
  for(const row of priceEditor.querySelectorAll(".price-grid")){
    const name=row.querySelector('input[type="text"]:not(.sku)')?.value?.trim()||"";
    const sku=row.querySelector('input.sku')?.value?.trim()||"";
    const isDeleted = row.dataset.deleted === "1";
    if(!sku){ continue; } // must have sku
    if(seen.has(sku)) continue; seen.add(sku);
    const rec={name,sku,is_deleted:isDeleted,size_prices:{}};
    for(const inp of row.querySelectorAll("input[data-size]")){
      const sz=inp.dataset.size; const v=inp.value;
      if(v!=="" && !isNaN(parseFloat(v))){ rec.size_prices[sz]=parseFloat(v); }
    }
    out.garments.push(rec);
  }
  saveOverrides(out);
  PRICING=loadPricing();
  rebuildAllGarmentLabels();
  priceModal.classList.remove("active");
  recalcAll();
}

function init(){ wireAll(); recalcAll(); }
init();

} // guard
</script>

  <!-- Export Modal -->
  <div class="modal" id="exportModal" aria-hidden="true">
    <div class="sheet" style="max-width:min(820px,96vw)">
      <div class="row between" style="margin-bottom:12px">
        <div><strong>Export Quote</strong> <span class="sub">Fill client & project details</span></div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="exportCancel" type="button">Cancel</button>
          <button class="btn" id="exportGo" type="button" onclick="(function(){ if(window.PQP_export_open){ window.PQP_export_open(); var m=document.getElementById('exportModal'); if(m) m.classList.remove('active'); } })()">Generate PDF</button>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <div class="cs-item">
          <label>Client name</label>
          <input type="text" id="ex_client_name" placeholder="Acme Co." />
        </div>
        <div class="cs-item">
          <label>Client email</label>
          <input type="text" id="ex_client_email" placeholder="client@example.com" />
        </div>
        <div class="cs-item">
          <label>Project name</label>
          <input type="text" id="ex_project_name" placeholder="Summer Event Tees" />
        </div>
        <div class="cs-item">
          <label>Special notes</label>
          <input type="text" id="ex_notes" placeholder="Any deadlines or special handling" />
        </div>
        <div class="cs-item">
          <label>Garment style</label>
          <input type="text" id="ex_style" placeholder="Auto from selections" readonly />
        </div>
        <div class="cs-item">
          <label>Garment code</label>
          <input type="text" id="ex_code" placeholder="Auto from selections" readonly />
        </div>
              </div>
    </div>
  </div>








<script>
(function(){

  // --- Minimal, robust template with placeholders ---
  const CLIENT_TPL = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta,.box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}
  .label{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}
  .value{font-weight:600;margin-top:2px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div><div class="label">Quote #</div><div class="value">{QUOTE}</div></div>
      <div><div class="label">Date Issued</div><div class="value">{ISSUED}</div></div>
      <div><div class="label">Expires</div><div class="value">{EXPIRES} <span style="color:var(--muted);font-size:12px">(14 days)</span></div></div>
      <div><div class="label">Client</div><div class="value">{CLIENT} · {EMAIL}</div></div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><div class="label">Project</div><div class="value">{PROJECT}</div></div>
        <div><div class="label">Special Notes</div><div class="value">{NOTES}</div></div>
        <div><div class="label">Garment Style / Code</div><div class="value">{STYLE} · {CODE}</div></div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Sizes &amp; Quantities</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>{SIZES}</td>
            <td><div><span class="label">Locations</span> <span class="value">{LOCS}</span></div>
                <div><span class="label">Print Size(s)</span> <span class="value">{PSIZES}</span></div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">{GARMENTS}</td></tr>
        <tr><td class="l">Printing</td><td class="r">{PRINTING}</td></tr>
        <tr><td class="l">Additional services</td><td class="r">{ADDSVC}</td></tr>
        <tr><td class="l">Discounts</td><td class="r">{DISC}</td></tr>
        <tr><td class="l">Setup fees</td><td class="r">{SETUP}</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">{SUBTOTAL}</td></tr>
        <tr><td class="l">Total</td><td class="r grand">{TOTAL}</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">{PERUNIT}</td></tr>
      </table>
      <div style="color:#667385;font-size:12px;margin-top:6px">Taxes handled separately if applicable.</div>
    </div>
  </div>


<!-- PressQuote Pro Export v3.9.21 -->
<script>
(function(){
  function $$(sel, root) { return Array.from((root||document).querySelectorAll(sel)); }
  function textOf(id) { var el = document.getElementById(id); return el ? (el.textContent||'').trim() : ''; }
  function parseMoney(s) { return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n) { return '$' + Number(n||0).toFixed(2); }

  function extractStyleAndCodeList(){
    var out = [];
    $$('#garmentLines .garment-line').forEach(function(line){
      var sel = line.querySelector('.garmentSel');
      var txt = sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
      if(!txt) return;
      var m = txt.match(/\(([^)]+)\)\s*$/);
      var code = m ? m[1].trim() : '';
      var style = m ? txt.replace(/\s*\([^)]*\)\s*$/, '').trim() : txt.trim();
      var total=0, parts=[];
      $$('.qty', line).forEach(function(inp){
        var n = parseInt(inp.value||'0',10), sz = inp.dataset.size;
        if(n>0) { total+=n; parts.push(sz + '×' + n); }
      });
      out.push({style:style, code:code, parts:parts, total:total});
    });
    return out;
  }

  function uniqJoin(arr){ var s=new Set(arr.filter(Boolean)); return s.size? Array.from(s).join(' • ') : '—'; }

  function placementsSummary(){
    var ids = [
      ['pl_left','Left chest','pl_left_w','pl_left_h'],
      ['pl_front','Full front','pl_front_w','pl_front_h'],
      ['pl_back','Full back','pl_back_w','pl_back_h'],
      ['pl_sleeve','Sleeve','pl_sleeve_w','pl_sleeve_h']
    ];
    var locs=[], sizes=[];
    ids.forEach(function(t){
      var id=t[0], label=t[1], wid=t[2], hid=t[3];
      var cb = document.getElementById(id);
      if(cb && cb.checked){
        locs.push(label);
        var w = (document.getElementById(wid)||{}).value || '0';
        var h = (document.getElementById(hid)||{}).value || '0';
        if(Number(w)>0 && Number(h)>0) sizes.push(label + ' ' + w + '″×' + h + '″');
      }
    });
    return { locs: (locs.length? locs.join(', ') : '—'),
             psizes: (sizes.length? sizes.join('; ') : '—') };
  }

  function buildGarmentTableHTML(list){
    if(!list.length) return '—';
    var rows = list.map(function(g){
      var left = (g.style + (g.code? ' ('+g.code+')':''));
      var right = (g.parts && g.parts.length? g.parts.join(', ') : '—') + (g.total? ' (total '+g.total+')':'');
      return '<tr><td>'+left+'</td><td>'+right+'</td></tr>';
    }).join('');
    return '<table style="width:100%;border-collapse:collapse"><thead><tr>' +
           '<th style="text-align:left;border-bottom:1px solid #e8ecf2;padding:6px 4px">Garment</th>' +
           '<th style="text-align:left;border-bottom:1px solid #e8ecf2;padding:6px 4px">Sizes &amp; Quantities</th>' +
           '</tr></thead><tbody>'+rows+'</tbody></table>';
  }

  function buildClientHTML(){
    var blanks = textOf('blanksAmt') || '$0.00';
    var gang = textOf('gangAmt') || '$0.00';
    var inbound = textOf('inboundAmt') || '$0.00';
    var labor = textOf('laborAmt') || '$0.00';
    var total_client = textOf('clientAmt') || '$0.00';
    var per_unit = textOf('perAmt') || '$0.00';

    var list = extractStyleAndCodeList();
    var styles = uniqJoin(list.map(function(x){return x.style;}));
    var codes  = uniqJoin(list.map(function(x){return x.code;}));
    var tableHTML = buildGarmentTableHTML(list);

    var p = placementsSummary();
    var printing = parseMoney(gang) + parseMoney(inbound) + parseMoney(labor);

    var now = new Date();
    var issued = now.toLocaleDateString();
    var expires = new Date(now.getTime()+14*24*60*60*1000).toLocaleDateString();
    var qn = 'PQP-'+ now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '-' + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

    var clientName = (document.getElementById('ex_client_name')||{}).value || '—';
    var clientEmail = (document.getElementById('ex_client_email')||{}).value || '—';
    var projectName = (document.getElementById('ex_project_name')||{}).value || '—';
    var notes = (document.getElementById('ex_notes')||{}).value || '—';

    var html = ''
      + '<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">'
      + '<title>Custom Apparel Estimate — PressQuote Pro</title>'
      + '<style>:root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}'
      + 'body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}'
      + '.wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}.hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}'
      + '.logo img{width:120px;height:auto;display:block}.brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}'
      + '.brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }.title{font-size:22px;font-weight:800;margin:8px 0 14px}'
      + '.meta,.box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}.meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}'
      + '.label{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}.value{font-weight:600;margin-top:2px}'
      + 'h3{font-size:14px;margin:18px 0 8px}table{width:100%;border-collapse:collapse}th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}'
      + 'th{font-size:12px;color:var(--muted)}.totals td{padding:6px 6px}.totals .l{color:var(--muted)}.totals .r{text-align:right;font-weight:600}.grand{font-size:18px;font-weight:800}.per{font-weight:700}'
      + '@media print{.noprint{display:none}}</style>'
      + '<body><div class="wrap">'
      + '<div class="hdr">'
      + '<div class="brand"><div class="name">Pigmacast Studio\'s PressQuote Pro</div><div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div></div></div>'
      + '<div class="title">Custom Apparel Estimate</div>'
      + '<div class="meta">'
      + '<div><div class="label">Quote #</div><div class="value">'+qn+'</div></div>'
      + '<div><div class="label">Date Issued</div><div class="value">'+issued+'</div></div>'
      + '<div><div class="label">Expires</div><div class="value">'+expires+' <span style="color:#667385;font-size:12px">(14 days)</span></div></div>'
      + '<div><div class="label">Client</div><div class="value">'+clientName+' · '+clientEmail+'</div></div>'
      + '</div>'
      + '<h3>Job Summary</h3><div class="box">'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">'
      + '<div><div class="label">Project</div><div class="value">'+projectName+'</div></div>'
      + '<div><div class="label">Special Notes</div><div class="value">'+notes+'</div></div>'
      + '<div><div class="label">Garment Style / Code</div><div class="value">'+styles+' · '+codes+'</div></div>'
      + '</div>'
      + '<div style="margin-top:10px">'+tableHTML+'</div>'
      + '<div style="margin-top:10px"><table><thead><tr><th>Print Specs</th></tr></thead><tbody><tr><td>'
      + '<div><span class="label">Locations</span> <span class="value">'+p.locs+'</span></div>'
      + '<div><span class="label">Print Size(s)</span> <span class="value">'+p.psizes+'</span></div>'
      + '</td></tr></tbody></table></div></div>'
      + '<h3>Pricing</h3><div class="box"><table class="totals">'
      + '<tr><td class="l">Garments (lump sum)</td><td class="r">'+blanks+'</td></tr>'
      + '<tr><td class="l">Printing</td><td class="r">'+fmt(printing)+'</td></tr>'
      + '<tr><td class="l">Additional services</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Discounts</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Setup fees</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Subtotal</td><td class="r">'+fmt(parseMoney(blanks)+printing)+'</td></tr>'
      + '<tr><td class="l">Total</td><td class="r grand">'+total_client+'</td></tr>'
      + '<tr><td class="l">Per unit</td><td class="r per">'+per_unit+'</td></tr>'
      + '</table><div class="noprint" style="margin-top:10px;color:#667385">Use your browser’s “Save as PDF”.</div></div>'
      + '</div>
<script>
(function(){ 
  function fmt(n){ return '$'+Number(String(n).replace(/[^0-9.\-]/g,'' )||0).toFixed(2); }

  function gatherGarments(){ 
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{ 
      const sel=line.querySelector('.garmentSel'); 
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }

  function placementSummary(){ 
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id); 
      if(cb && cb.checked){ 
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }

  function snapshotTotals(){
    const el = (id) => { const n=(document.getElementById(id)||{}).textContent||'$0.00'; return n; };
    return {
      blanks: el('blanksAmt'),
      gang: el('gangAmt'),
      inbound: el('inboundAmt'),
      labor: el('laborAmt'),
      sub: el('subAmt'),
      total: el('clientAmt'),
      per: el('perAmt'),
      units: (document.getElementById('unitsAmt')||{}).textContent||'0'
    };
  }

  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' + 
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') + 
           '</tbody></table>';
  }

  window.PQP_export_open = function(){ 
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const LOGO_B64 = \"data:image/png;base64,\" + (window.PQP_LOGO_B64||\"\");
\1<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}}
  body{{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}}
  .wrap{{max-width:820px;margin:24px auto;padding:0 16px 28px}}
  .hdr{{display:flex;align-items:center;gap:12px;margin-bottom:10px}}
  .logo img{{width:120px;height:auto;display:block}}
  .brand .name{{font-weight:800;font-size:18px;letter-spacing:.2px}}
  .brand .contact a{{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}}
  .title{{font-size:22px;font-weight:800;margin:8px 0 14px}}
  .meta,.box{{border:1px solid var(--line);border-radius:10px;padding:10px 12px}}
  .meta{{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}}
  .label{{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}}
  .value{{font-weight:600;margin-top:2px}}
  h3{{font-size:14px;margin:18px 0 8px}}
  table{{width:100%;border-collapse:collapse}}
  th,td{{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}}
  th{{font-size:12px;color:var(--muted)}}
  .totals td{{padding:6px 6px}}
  .totals .l{{color:var(--muted)}}
  .totals .r{{text-align:right;font-weight:600}}
  .grand{{font-size:18px;font-weight:800}}
  .per{{font-weight:700}}
  .fine{{color:var(--muted);font-size:12px;margin-top:6px}}
  @media print{{body{{margin:0}}.wrap{{max-width:7.4in;margin:.2in auto;padding:0}}}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div><div class="label">Quote #</div><div class="value">QNUM</div></div>
      <div><div class="label">Date Issued</div><div class="value">ISSUED</div></div>
      <div><div class="label">Expires</div><div class="value">EXPIRES <span style="color:var(--muted);font-size:12px">(14 days)</span></div></div>
      <div><div class="label">Client</div><div class="value">CLIENT · CEMAIL</div></div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><div class="label">Project</div><div class="value">PROJECT</div></div>
        <div><div class="label">Special Notes</div><div class="value">CNOTES</div></div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> <span class="value">LOCATIONS</span></div>
                <div><span class="label">Print Size(s)</span> <span class="value">PSIZES</span></div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing</td><td class="r">P_GANG</td></tr>
        <tr><td class="l">Inbound shipping (Ninja)</td><td class="r">P_INBOUND</td></tr>
        <tr><td class="l">Labor</td><td class="r">P_LABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script id="modal-top-scroll-patch">
(function(){
  function $(s, r=document){ return r.querySelector(s); }
  function bindScrollTop(){
    const open = $('#exportBtn');
    const modal = $('#exportModal');
    if(!open || !modal) return;
    open.addEventListener('click', function(){
      try {
        window.scrollTo({top: 0, behavior: 'instant'});
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      } catch(e){}
    }, {capture:true});
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindScrollTop);
  else bindScrollTop();
})();
</script>


<script id="pqp-scrim">(function(){
  function lsGet(k){ try { return window.localStorage ? localStorage.getItem(k) : null; } catch(e){ return null; } }
  function lsSet(k,v){ try { if (window.localStorage) localStorage.setItem(k,v); } catch(e){} }
  const LS_KEY = 'pqpScrim';
  const state = Object.assign({enabled:true, h:360}, (function(){ try { return JSON.parse(lsGet(LS_KEY) || '{}'); } catch(e){ return {}; } })());
  const root = document.documentElement;

  const scrim = document.createElement('div'); scrim.id = 'pqpScrim';
  const btn = document.createElement('button'); btn.id = 'pqpScrimBtn';
  const panel = document.createElement('div'); panel.id = 'pqpScrimPanel';

  btn.textContent = state.enabled ? 'Hide bottom: ON' : 'Hide bottom: OFF';
  panel.innerHTML = `
    <label>Bottom cover height</label>
    <input id="pqpScrimRange" type="range" min="0" max="5000" step="20" value="${state.h}">
    <div class="row">
      <input id="pqpScrimNum" type="number" min="0" max="10000" step="10" value="${state.h}"> <span>px</span>
      <button id="pqpScrimClose" type="button">Close</button>
    </div>
    <div class="row">
      <button id="pqpScrim50" type="button">50%</button>
      <button id="pqpScrim75" type="button">75%</button>
      <button id="pqpScrim90" type="button">90%</button>
      <button id="pqpScrimFull" type="button">Full</button>
    </div>
    <div class="row">
      <button id="pqpScrimReset" type="button">Reset</button>
      <button id="pqpScrimToggle" type="button">${state.enabled ? 'Turn OFF' : 'Turn ON'}</button>
    </div>
  `;

  function apply(){
    root.style.setProperty('--pqp-scrim-h', state.h + 'px');
    scrim.style.display = state.enabled ? 'block' : 'none';
    btn.textContent = state.enabled ? 'Hide bottom: ON' : 'Hide bottom: OFF';
    const t = panel.querySelector('#pqpScrimToggle');
    if(t) t.textContent = state.enabled ? 'Turn OFF' : 'Turn ON';
    lsSet(LS_KEY, JSON.stringify(state));
  }

  function showPanel(show){ panel.style.display = show ? 'block' : 'none'; }

  btn.addEventListener('click', (e)=>{
    if (e.shiftKey) { state.enabled = !state.enabled; apply(); }
    else { showPanel(panel.style.display!=='block'); }
  });

  panel.addEventListener('click', (e)=>{ const id = e.target && e.target.id;
    if (id === 'pqpScrimClose') showPanel(false);
    if (id === 'pqpScrimReset') { state.h = 360; apply(); syncInputs(); }
    if (id === 'pqpScrimToggle') { state.enabled = !state.enabled; apply(); }
    if (id === 'pqpScrim50') { state.h = Math.round(window.innerHeight * 0.50); apply(); syncInputs(); }
    if (id === 'pqpScrim75') { state.h = Math.round(window.innerHeight * 0.75); apply(); syncInputs(); }
    if (id === 'pqpScrim90') { state.h = Math.round(window.innerHeight * 0.90); apply(); syncInputs(); }
    if (id === 'pqpScrimFull') { state.h = window.innerHeight; apply(); syncInputs(); }
  });

  function syncInputs(){
    const r = panel.querySelector('#pqpScrimRange');
    const n = panel.querySelector('#pqpScrimNum');
    if(r) r.value = state.h;
    if(n) n.value = state.h;
  }
  panel.addEventListener('input', (e)=>{
    if(e.target.id==='pqpScrimRange' || e.target.id==='pqpScrimNum'){
      const v = Math.max(0, Math.min(10000, parseInt(e.target.value||0,10)||0));
      state.h = v; apply(); syncInputs();
    }
  });

  window.addEventListener('keydown', (e)=>{
    if (e.key.toLowerCase() === 's' && e.ctrlKey && e.shiftKey) { state.enabled = !state.enabled; apply(); }
    else if (e.key.toLowerCase() === 's' && e.ctrlKey && e.altKey) { showPanel(panel.style.display!=='block'); }
  });

  document.body.appendChild(scrim);
  document.body.appendChild(btn);
  document.body.appendChild(panel);
  apply();
})();
</script>

</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, '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')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_GANG/g, t.gang)
      .replace(/P_INBOUND/g, t.inbound)
      .replace(/P_LABOR/g, t.labor)
      .replace(/P_SUB/g, t.sub)
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; 
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };

  const exportBtn=document.getElementById('exportBtn');
  const exportModal=document.getElementById('exportModal');
  const exportCancel=document.getElementById('exportCancel');
  if(exportBtn && exportModal){ exportBtn.addEventListener('click', ()=> exportModal.classList.add('active')); }
  if(exportCancel){ exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active')); }
  if(exportModal){ exportModal.addEventListener('click', (e)=>{ if(e.target===exportModal) exportModal.classList.remove('active'); }); }
})();
</script>


<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body></html>';

    return html.replace('LOGO64','/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAA0JCgsKCA0LCgsODg0PEyAVExISEyccHhcgLikxMC4pLSwzOko+MzZGNywtQFdBRkxOUlNSMj5aYVpQYEpRUk//2wBDAQ4ODhMREyYVFSZPNS01T09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0//wgARCACkAHgDASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAUCAwQBBv/EABkBAQADAQEAAAAAAAAAAAAAAAACAwQFAf/aAAwDAQACEAMQAAAB9HgkwFoyBaMgWjLguGQLRkC0ZYzYdBcxXMQAAAr8tpq05X2vy/pI3WAUWC5iuGIAuYrmIAAq2ednSdlDpYY68cfel6/qhvzJi5iuh4xAFzFcxDnUjzDMj0eXyEo23Q5azj0VHqZzxTFzFdRUxAFzFcxDyfo/N3Zbo9bbM2JvoMXQhPOhrucrF+rza6q52GRiBOpcxXMTCk9NGymrUIo3MUeSc+lC2V0NPNHbudRqhpzaecxAuguYrmIQnUecz6bHTzWabM1lF1s8lMLu7I55r2K7q5mIHpcxXMQKpHV+3sfcEtvctmO26bzkoR112rteP0yAFzFcxMXNgYea4lMdPCEL4nar7DPRvwDEAXMV/TeKw3dwBujjDfDGG65WDRdDIPwAAAAAAAAAAAAAA//EACYQAAEEAQQCAgIDAAAAAAAAAAIAAQMENBAREhQTICExBSMkMkD/2gAIAQEAAQUCkMYw79Vd+qu/VXfqrv1V36q79Vd+qu/VXfqrv1V36q79XS/h+3xv62yeOsr+H6mTAHMpZa8vkH0v4Sv4frbl7EqA3jMDYw1v4Sv4fpdncGEWAdK03iPW/hK/h6zzDBEDE7+lObW/hK/h6fSOTszeosTlE5PGr+Er+Hp+QldfDNqIEaipoREG0v4Sv4egl5ZtIq5SIYYxZhYdJrMUSK3MaryPIN/CV/DVkuNeFtoPt4a22ss0cIy2pZUIsyFlV/tfwlfw1dw4BcwihaPSezHApLUpvtuTMmZMyrt838JX8NELEIRiGli6mb5TMmFMyZlE2w38JX8PQiYRnsFZTCuKYUwpmTMhbd1fwlfw9JIxljKIoS4riuK2WyZkI8dL+Er+HqQsTPWcVwJcVxdNG6ZmbW/hK/hryBvybfyBycxYuY8uQ8iMQX2hJiZpBcvIG9596Kv4aHk6fdpmfx1iJxlDcZYuWwt/Ikk3hDcUDgER/Et/CV/DTMzLZuTkLHJsxE0e/KN4RLkQuJCLjItmWzO9/CV/D1IHdzDkiDcvE3hENiaL9LB+zS/hK/hyXIIz79Zd+su/WXfrLv1l36y79Zd+su/WXfrLv1lbtwyVv8H/xAAkEQACAgECBgMBAAAAAAAAAAABAgADEQQgEhMhMTJCECIwQP/aAAgBAwEBPwH877PQSs5G66zlrE6mVLGXhOwnAzGc2NmViV4Ess4tmqbCYlVZbtFQLErZzhYulVfKXAB+nzbVzMRK/VZXowPKdEGBHeWHLbKCir9YbYzx3xtBI7TmmGw/2f/EACURAAICAQMCBwEAAAAAAAAAAAECAAMREiAxBBATISIwMkBBYf/aAAgBAgEBPwH26K8+oy6rScjdWmswDEKhhgx0KHB21ppHZrUWXXeJ+bKBlozhB5x7WeAEx8LFbUM9630QksYEA5j2gS27Mo+A2G0JH6mPdmVVm1v5tZQ3MbpAeDF6NBzAABgfb//EADYQAAECAgcHAwIEBwAAAAAAAAEAAhARAxIhMTJxgSAiM1GSobETQWEEIzBCYpFAQ1JyweHx/9oACAEBAAY/Ai95k0Li9iuL2K4vYri9iuL2K4vYri9iuL2K4vYri9iuL2K4vYri9jB+nnbltPey8Qfp52i5xkAjTusnhHIK3ENmkyg/Tztek3hsxfJhWCDhsUmUH6edn0qPiP7KqI24TsUmUH6edgvd/wBRpKTG7ts+m7SNJlB+nnYr/wAtmD5+drdnP4QriToUmUH6eYt+nZe+/JSF2xuhTpToFJolGkyg/TzGkpuZkMozuapAKwQkTN39IvW6AwfuUa16pMoP08wpHcmlNyVirUl/KM6R0lJv22d1ZAqkyg/TzCl/tTA3kubucN613s0Kz/QVZxrO5nYKpMoP08wLXXFbglAs+n1ep3k3k7dJlB+nmJc4yAVVs20Xd34NJlB+nmJY8TBVR935Xc/waTKD9POxJwmCvtmzk5WtKuVyt2KTKD9PMJTQE7Sqta1VZ2qrO1VZ2reMpwm0zCkCpVrlSEQfp5hS1TI1/wDAQE5n00yUgJWklF3JgPdOrfmm5CklxDM5eypHO5CWSPpm1xqgotlujCqPekPb5VGB7kz/AGVJlB+nmBl7qfug33vuQ3Jl1miDSLSJaKscEkd2z5Vcy3SdEHAZWK5A8lSZQfp52Jg+3JN/SZoOnaAUKOd0k508SNGTfNV5+0o0mUH6eUWOcZj4WM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JT2McST+k/wAD/8QAKBAAAQIFAwUAAwEBAAAAAAAAAQARECExYfBBUaEgcbHB0YGR8eFA/9oACAEBAAE/IdVACsHyWD5LB8lg+SwfJYPksHyWD5LB8lg+SwfJYPksHyQIIcUKwrEw2TDZMNkw2TDZMNk+gfZMNkw2TDZMNkw2R+ABSLPrDCs6mczclB2lBBJ7i9+ngvIhhWdU4p03EigSqOVSxPRwXkQwrOkbLtW7ob0dd0UVID37XVaR4LyIYVnRpB0G7ZTD55s2RRRg/PmK/UeC8iGFZEkASSwCM/rMG5CUUUYADSGiEzfhDgvIhhWRMBDTz2UAMTAGCMKyCIMUoOC/KbDC0eC8iGFZF6/UkUVO3eOq12ak1KpQIFf2xQhlj8KRBh0XBeRDCsgx1WH6TV7kAQAHJ0QWTP0CLQgaDU9k+u2q/ipD/YEgbLgvIhhWQB2NyAk5IoW/cgEMTlwVJkA49ynOMiHI9MrLgvIhhWQEw4WIsgbBC0CEsiRLQHbdMkRO6BKA6WyebrgvIhhWRBgCckp+4T/gmAwDBDpAjIAgGAA0XBeRDCsi0Mc0BzTlo2HYoKECBQhSWATS8OC8iGFZ0E4lQCKrUP8AS7FAVFynDV+kDUJWBDZCPBeRDCsgQGQuJGyp0w4CmGCFQNEAED6BaHbotLNDsmhnQG6BAOKJvDcCJhSRIsiImHJjZAMHDe4YVkBIItQQ6AEGJsTqXCE8Tpo0mbl1LmSUbarhGGZXGwYDhHpIr7SY3ot4AAjp/SC8j3OOo7T/AEhLJDH4BCIUocGLqIiWMGAapwXkQwrIFCBnOblaSJGeyPEPpBzXRbyvyTCzsA35ekZTPdMaIz9ogMQmXQgEQ0OjHCfElUWSQEzBKkkTAATQdlwXkQwrOgyBBLKDqnJu2LymOaEEt/4qjMIA9v4nuIkn7IE0Cce5P1MERkkGaCPBeRDCsQGSsHlZJ6WSelknpZJ6WSelknpZJ6WSelknpZJ6WSekHAchc/4f/9oADAMBAAIAAwAAABBzzzjzzjCgADIEBQCgAuQeFQChaBK/BQCgMkC/PYCj+QKVZ8ChBVoSPYCgRdvoVgCiiCQTzQCAwywyxgAAAAAAAAD/xAAiEQEAAgIBAgcAAAAAAAAAAAABABEhMSAQQTBAUWGBkaH/2gAIAQMBAT8Q8PL9kUb3yGzu6gbHbLiolDwBFojF/EyxDbAIBrg1DuxiDMSrFwW3b+RUadcAuBjNDCrdsGo0SyXLwu+zt79K2Vvfi7anrxWoq5fN/wD/xAAgEQEAAgIBBAMAAAAAAAAAAAABABEgITEQQVGRMEDR/9oACAECAQE/EPjveieKHJae0IURjxMc4QK0Qq4QW1gUCle8N74l8jWOjxEdSjvnCG01uWZ2wC4BoliBGe+8BK6DxunDn8gAUYAULi2wiltZWij7f//EACkQAQACAQMEAgICAgMAAAAAAAEAESExQWEQUYGRIHGhwbHh0fAwQPH/2gAIAQEAAT8QCmUXFq2tDOrOJBxIOJBxIOJBxIOJBxIOJBxIOJBxIOJATawsemHA9TgepwPU4HqcD1OB6iISWWYXWl/mcD1OB6nA9TgepwPUGQ9Y0wNHG8NPngcxB2wRUaufVLZ5XMK0K6P4fJCNPngq2xpuA0+p/PiUCgoNAjj5cmw3GMnZ6bjuPPxhGnywx/mkeV9uP6mlZqWq3WOKLqQrm/1mCAUI5E+EI0+OCXWGjcpoPuJtb/hD2DEXUZSMUzbn+sfCEafDAywLVaAmRVhvkR/H/vSUXQwgdBoVHviPPopkzzjv26wjT4YIlwFta+6fT3laog7EUWNoBV0DKx4puijV4787EBVh1sx5/wAIJJ9jXwhGnXBaLYuWi8eA/UcUoL02s/Q/cdlaVlfY9uIQlxrR0tW2wu+zbzUfG21P6npjndtlFJj99IRp1wVxSX2tUILezy3EiKoBasqyaxr+zu/iBRRFAtQDvLDBjWXsDKzLGd2Pl/XPMwoltrqruu80cQO0JfT/AH0hGnXBg6rPU8VsAVq8TfsMhpwdjoBSfd+LY5Zqx+D/AGebQ2DWWxOpa0OwbHBEU45XtKOBPz0hGnXCzbvfIpI3bqwKwYD6igWtBHZyxL4+9zp9yw/rVb5YrLGcE4JXtLl7/wAHSEafDC5GhqAi2Sq/Z7cN4RmDABpGdpwyraccpj76/EM1QKOkI0+GGLEg/hORzGRsYFdj+B32nFD7Tjle0M2gK0u0PLl6vWEafHAD/VbA5IzfZWX6aocN+JikOKHshrg8p+qUdlA9spH3O78IRp1wvWugttV0+EiLbpbyhq/UxRVWRbs1p5gGw3updXBWEK05TF57YgiDERcg6L6ZltKmcrg1YZe1pMn6qyx8xo/0ZA7i6XxLZNALbdmt5bKDT4w064OciLwN6hIuI+LJ0L9sv2hVI1YMp5WwAlBBqidWd0qzKtMDZ/0vzGAVlIW0Mt2BjywCk4nBWu12v6O0D1ky6WpTcyYxDApsKLRSUN0Ua95YyaqWVYa23n2xkT3AMznvnpCNOuAIVdnYC3wHqLh1Ud9m69hEiuVVRdWaxm/zAbL3VgybPbXG6xDsvk3hRdiHijNKHbjX68Qlco4UrRExWMSnnD2AkbQ2G9tYMto2yVuXmmiJIOWAxetR65q2timvHSEafHADiDdSrXnL9aGs1EgOLvCVD7nQhgZ8ImKWQS22IvkSjldKoAUB/mBXVoFNM/EOdJSAAqv2r8IRpApArsCCC1ADFl6hW/8AyBAgQIECBAgQIEH9QYLaOqcQ0P8Aof/Z');
  }

  window.PQP_DO_EXPORT = function(){
    try {
      var html = buildClientHTML();
      var iframe = document.createElement('iframe');
      iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
      iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
      iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
      document.body.appendChild(iframe);
      iframe.srcdoc = html;
      iframe.onload = function(){
        try{ var win=iframe.contentWindow; if(win){ win.focus(); win.print(); } }
        catch(e){ alert('Printing blocked. Use Save as PDF.'); }
        finally { setTimeout(function(){ iframe.remove(); }, 1500); }
      };
    } catch (e) { alert('Export failed: '+e.message); console.error(e); }
  };

  // Bind buttons idempotently
  var exportBtn = document.getElementById('exportBtn');
  if (exportBtn && !exportBtn.dataset.bound) { exportBtn.dataset.bound='1'; exportBtn.addEventListener('click', function(){ var m=document.getElementById('exportModal'); if(m) m.classList.add('active'); }); }
  var go = document.getElementById('exportGo');
  if (go && !go.dataset.bound) { go.dataset.bound='1'; go.addEventListener('click', function(){ window.PQP_DO_EXPORT(); var m=document.getElementById('exportModal'); if(m) m.classList.remove('active'); }); }
  var cancel = document.getElementById('exportCancel');
  if (cancel && !cancel.dataset.bound) { cancel.dataset.bound='1'; cancel.addEventListener('click', function(){ var m=document.getElementById('exportModal'); if(m) m.classList.remove('active'); }); }
})();
</script>


<script>
(function(){ 
  function fmt(n){ return '$'+Number(String(n).replace(/[^0-9.\-]/g,'' )||0).toFixed(2); }

  function gatherGarments(){ 
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{ 
      const sel=line.querySelector('.garmentSel'); 
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }

  function placementSummary(){ 
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id); 
      if(cb && cb.checked){ 
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }

  function snapshotTotals(){
    const el = (id) => { const n=(document.getElementById(id)||{}).textContent||'$0.00'; return n; };
    return {
      blanks: el('blanksAmt'),
      gang: el('gangAmt'),
      inbound: el('inboundAmt'),
      labor: el('laborAmt'),
      sub: el('subAmt'),
      total: el('clientAmt'),
      per: el('perAmt'),
      units: (document.getElementById('unitsAmt')||{}).textContent||'0'
    };
  }

  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' + 
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') + 
           '</tbody></table>';
  }

  window.PQP_export_open = function(){ 
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}}
  body{{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}}
  .wrap{{max-width:820px;margin:24px auto;padding:0 16px 28px}}
  .hdr{{display:flex;align-items:center;gap:12px;margin-bottom:10px}}
  .logo img{{width:120px;height:auto;display:block}}
  .brand .name{{font-weight:800;font-size:18px;letter-spacing:.2px}}
  .brand .contact a{{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}}
  .title{{font-size:22px;font-weight:800;margin:8px 0 14px}}
  .meta,.box{{border:1px solid var(--line);border-radius:10px;padding:10px 12px}}
  .meta{{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}}
  .label{{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}}
  .value{{font-weight:600;margin-top:2px}}
  h3{{font-size:14px;margin:18px 0 8px}}
  table{{width:100%;border-collapse:collapse}}
  th,td{{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}}
  th{{font-size:12px;color:var(--muted)}}
  .totals td{{padding:6px 6px}}
  .totals .l{{color:var(--muted)}}
  .totals .r{{text-align:right;font-weight:600}}
  .grand{{font-size:18px;font-weight:800}}
  .per{{font-weight:700}}
  .fine{{color:var(--muted);font-size:12px;margin-top:6px}}
  @media print{{body{{margin:0}}.wrap{{max-width:7.4in;margin:.2in auto;padding:0}}}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div><div class="label">Quote #</div><div class="value">QNUM</div></div>
      <div><div class="label">Date Issued</div><div class="value">ISSUED</div></div>
      <div><div class="label">Expires</div><div class="value">EXPIRES <span style="color:var(--muted);font-size:12px">(14 days)</span></div></div>
      <div><div class="label">Client</div><div class="value">CLIENT · CEMAIL</div></div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><div class="label">Project</div><div class="value">PROJECT</div></div>
        <div><div class="label">Special Notes</div><div class="value">CNOTES</div></div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> <span class="value">LOCATIONS</span></div>
                <div><span class="label">Print Size(s)</span> <span class="value">PSIZES</span></div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing</td><td class="r">P_GANG</td></tr>
        <tr><td class="l">Inbound shipping (Ninja)</td><td class="r">P_INBOUND</td></tr>
        <tr><td class="l">Labor</td><td class="r">P_LABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, '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')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_GANG/g, t.gang)
      .replace(/P_INBOUND/g, t.inbound)
      .replace(/P_LABOR/g, t.labor)
      .replace(/P_SUB/g, t.sub)
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; 
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };

  const exportBtn=document.getElementById('exportBtn');
  const exportModal=document.getElementById('exportModal');
  const exportCancel=document.getElementById('exportCancel');
  if(exportBtn && exportModal){ exportBtn.addEventListener('click', ()=> exportModal.classList.add('active')); }
  if(exportCancel){ exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active')); }
  if(exportModal){ exportModal.addEventListener('click', (e)=>{ if(e.target===exportModal) exportModal.classList.remove('active'); }); }
})();
</script>


<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`;
    // Normalize embedded-logo tokens and ensure correct data URI
    (function(){
      const LOGO_B64 = (window.PQP_LOGO_B64||"");
      if (LOGO_B64) {
        html = html
          .replace(/data:image\/(?:png|jpeg);base64,(?:EM_LOGO|\{EMBED_LOGO\})/g, 'data:image/png;base64,' + LOGO_B64)
          .replace(/EM_LOGO|\{EMBED_LOGO\}/g, LOGO_B64);
      }
    })();


  function $$(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  function textOf(id){ const el = document.getElementById(id); return el ? el.textContent.trim() : ''; }
  function parseMoney(s){ return Number((s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$' + Number(n||0).toFixed(2); }

  function gatherSizesSummary(){
    const lines = [];
    $$('#garmentLines .garment-line').forEach(line => {
      const sel = line.querySelector('.garmentSel');
      const skuText = sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
      if(!skuText) return;
      let total=0, parts=[];
      $$('.qty', line).forEach(inp => {
        const n = parseInt(inp.value||'0'), sz = inp.dataset.size;
        if(n>0){ total+=n; parts.push(sz + '×' + n); }
      });
      if(total>0) lines.push((skuText? skuText + ': ' : '') + parts.join(', ') + ' (total ' + total + ')');
    });
    return lines.length ? lines.join(' • ') : '—';
  }

  function placementsSummary(){
    const ids = [
      ['pl_left','Left chest','pl_left_w','pl_left_h'],
      ['pl_front','Full front','pl_front_w','pl_front_h'],
      ['pl_back','Full back','pl_back_w','pl_back_h'],
      ['pl_sleeve','Sleeve','pl_sleeve_w','pl_sleeve_h']
    ];
    const locs=[], sizes=[];
    ids.forEach(([id,label,wid,hid])=>{
      const cb = document.getElementById(id);
      if(cb && cb.checked){
        locs.push(label);
        const w = (document.getElementById(wid)?.value)||'0';
        const h = (document.getElementById(hid)?.value)||'0';
        if(Number(w)>0 && Number(h)>0) sizes.push(label + ' ' + w + '″×' + h + '″');
      }
    });
    return { locs: (locs.length? locs.join(', ') : '—'), psizes: (sizes.length? sizes.join('; ') : '—') };
  }
  // Global alias for inline calls
  window.PQP_export_open = openClientDoc;

  function extractStyleAndCode(){
    const styles=[], codes=[];
    $$('#garmentLines .garment-line .garmentSel').forEach(sel => {
      const txt = sel.options[sel.selectedIndex]?.text || '';
      if(!txt) return;
      const m = txt.match(/\(([^)]+)\)\s*$/);
      const code = m ? m[1].trim() : '';
      const style = m ? txt.replace(/\s*\([^)]*\)\s*$/, '').trim() : txt.trim();
      if(style && !styles.includes(style)) styles.push(style);
      if(code && !codes.includes(code)) codes.push(code);
    });
    return { style: styles.length? styles.join(' • '):'—', code: codes.length? codes.join(' • '):'—' };
  }
  // Global alias for inline calls
  window.PQP_export_open = openClientDoc;

  
  function openClientDoc(){
    try { console.log('[PQP] export start'); } catch(e) {} 
    const blanks = textOf('blanksAmt') || '$0.00';
    const gang = textOf('gangAmt') || '$0.00';
    const inbound = textOf('inboundAmt') || '$0.00';
    const labor = textOf('laborAmt') || '$0.00';
    const total_client = textOf('clientAmt') || '$0.00';
    const per_unit = textOf('perAmt') || '$0.00';

    const sizes = gatherSizesSummary();
    const p = placementsSummary();
    const sc = extractStyleAndCode();

    const printing = parseMoney(gang) + parseMoney(inbound) + parseMoney(labor);

    const now = new Date();
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*24*60*60*1000).toLocaleDateString();
    const qn = 'PQP-'+ now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '-' + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

    const filled = CLIENT_TPL
      .replace(/\{\{EMBED_LOGO\}\}/g, "{{EMBED_LOGO_PLACEHOLDER}}")
      .replace(/\{\{QUOTE\}\}/g, qn)
      .replace(/\{\{ISSUED\}\}/g, issued)
      .replace(/\{\{EXPIRES\}\}/g, expires)
      .replace(/\{\{CLIENT\}\}/g, (document.getElementById('ex_client_name')?.value || '—'))
      .replace(/\{\{EMAIL\}\}/g, (document.getElementById('ex_client_email')?.value || '—'))
      .replace(/\{\{PROJECT\}\}/g, (document.getElementById('ex_project_name')?.value || '—'))
      .replace(/\{\{NOTES\}\}/g, (document.getElementById('ex_notes')?.value || '—'))
      .replace(/\{\{STYLE\}\}/g, sc.style)
      .replace(/\{\{CODE\}\}/g, sc.code)
      .replace(/\{\{SIZES\}\}/g, sizes)
      .replace(/\{\{LOCS\}\}/g, p.locs)
      .replace(/\{\{PSIZES\}\}/g, p.psizes)
      .replace(/\{\{GARMENTS\}\}/g, blanks)
      .replace(/\{\{PRINTING\}\}/g, (fmt(printing)))
      .replace(/\{\{ADDSVC\}\}/g, '$0.00')
      .replace(/\{\{DISC\}\}/g, '$0.00')
      .replace(/\{\{SETUP\}\}/g, '$0.00')
      .replace(/\{\{SUBTOTAL\}\}/g, fmt(parseMoney(blanks)+printing))
      .replace(/\{\{TOTAL\}\}/g, total_client)
      .replace(/\{\{PERUNIT\}\}/g, per_unit)
      .replace("{{EMBED_LOGO_PLACEHOLDER}}", "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");

    // Use an iframe with srcdoc to avoid popup blockers and about:blank issues
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    iframe.setAttribute('sandbox', 'allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);

    // Fill srcdoc
    iframe.srcdoc = filled;

    iframe.onload = () => {
      try {
        const win = iframe.contentWindow;
        if (win) {
          win.focus();
          win.print();
        }
      } catch (e) {
        console.error('Print error:', e);
        alert('Unable to open the print dialog. Please check browser permissions.');
      } finally {
        setTimeout(() => { iframe.remove(); }, 1500);
      }
    };
  }
  // Global alias for inline calls
  window.PQP_export_open = openClientDoc;

    w.document.open(); w.document.write(filled); w.document.close();
    w.onload = () => setTimeout(()=> w.print(), 200);
  }

  // Bind buttons
  const exportBtn = document.getElementById('exportBtn');
  const exportModal = document.getElementById('exportModal');
  const exportCancel = document.getElementById('exportCancel');
  const exportGo = document.getElementById('exportGo');

  if (exportBtn) exportBtn.onclick = () => exportModal.classList.add('active');
  if (exportCancel) exportCancel.onclick = () => exportModal.classList.remove('active');
  if (exportGo) exportGo.onclick = () => { openClientDoc(); exportModal.classList.remove('active'); };

})();
</script>



<!-- PressQuote Pro Export v3.9.21 -->
<script>
(function(){
  function $$(sel, root) { return Array.from((root||document).querySelectorAll(sel)); }
  function textOf(id) { var el = document.getElementById(id); return el ? (el.textContent||'').trim() : ''; }
  function parseMoney(s) { return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n) { return '$' + Number(n||0).toFixed(2); }

  function extractStyleAndCodeList(){
    var out = [];
    $$('#garmentLines .garment-line').forEach(function(line){
      var sel = line.querySelector('.garmentSel');
      var txt = sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
      if(!txt) return;
      var m = txt.match(/\(([^)]+)\)\s*$/);
      var code = m ? m[1].trim() : '';
      var style = m ? txt.replace(/\s*\([^)]*\)\s*$/, '').trim() : txt.trim();
      var total=0, parts=[];
      $$('.qty', line).forEach(function(inp){
        var n = parseInt(inp.value||'0',10), sz = inp.dataset.size;
        if(n>0) { total+=n; parts.push(sz + '×' + n); }
      });
      out.push({style:style, code:code, parts:parts, total:total});
    });
    return out;
  }

  function uniqJoin(arr){ var s=new Set(arr.filter(Boolean)); return s.size? Array.from(s).join(' • ') : '—'; }

  function placementsSummary(){
    var ids = [
      ['pl_left','Left chest','pl_left_w','pl_left_h'],
      ['pl_front','Full front','pl_front_w','pl_front_h'],
      ['pl_back','Full back','pl_back_w','pl_back_h'],
      ['pl_sleeve','Sleeve','pl_sleeve_w','pl_sleeve_h']
    ];
    var locs=[], sizes=[];
    ids.forEach(function(t){
      var id=t[0], label=t[1], wid=t[2], hid=t[3];
      var cb = document.getElementById(id);
      if(cb && cb.checked){
        locs.push(label);
        var w = (document.getElementById(wid)||{}).value || '0';
        var h = (document.getElementById(hid)||{}).value || '0';
        if(Number(w)>0 && Number(h)>0) sizes.push(label + ' ' + w + '″×' + h + '″');
      }
    });
    return { locs: (locs.length? locs.join(', ') : '—'),
             psizes: (sizes.length? sizes.join('; ') : '—') };
  }

  function buildGarmentTableHTML(list){
    if(!list.length) return '—';
    var rows = list.map(function(g){
      var left = (g.style + (g.code? ' ('+g.code+')':''));
      var right = (g.parts && g.parts.length? g.parts.join(', ') : '—') + (g.total? ' (total '+g.total+')':'');
      return '<tr><td>'+left+'</td><td>'+right+'</td></tr>';
    }).join('');
    return '<table style="width:100%;border-collapse:collapse"><thead><tr>' +
           '<th style="text-align:left;border-bottom:1px solid #e8ecf2;padding:6px 4px">Garment</th>' +
           '<th style="text-align:left;border-bottom:1px solid #e8ecf2;padding:6px 4px">Sizes &amp; Quantities</th>' +
           '</tr></thead><tbody>'+rows+'</tbody></table>';
  }

  function buildClientHTML(){
    var blanks = textOf('blanksAmt') || '$0.00';
    var gang = textOf('gangAmt') || '$0.00';
    var inbound = textOf('inboundAmt') || '$0.00';
    var labor = textOf('laborAmt') || '$0.00';
    var total_client = textOf('clientAmt') || '$0.00';
    var per_unit = textOf('perAmt') || '$0.00';

    var list = extractStyleAndCodeList();
    var styles = uniqJoin(list.map(function(x){return x.style;}));
    var codes  = uniqJoin(list.map(function(x){return x.code;}));
    var tableHTML = buildGarmentTableHTML(list);

    var p = placementsSummary();
    var printing = parseMoney(gang) + parseMoney(inbound) + parseMoney(labor);

    var now = new Date();
    var issued = now.toLocaleDateString();
    var expires = new Date(now.getTime()+14*24*60*60*1000).toLocaleDateString();
    var qn = 'PQP-'+ now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '-' + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

    var clientName = (document.getElementById('ex_client_name')||{}).value || '—';
    var clientEmail = (document.getElementById('ex_client_email')||{}).value || '—';
    var projectName = (document.getElementById('ex_project_name')||{}).value || '—';
    var notes = (document.getElementById('ex_notes')||{}).value || '—';

    var html = ''
      + '<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">'
      + '<title>Custom Apparel Estimate — PressQuote Pro</title>'
      + '<style>:root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}'
      + 'body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}'
      + '.wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}.hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}'
      + '.logo img{width:120px;height:auto;display:block}.brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}'
      + '.brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }.title{font-size:22px;font-weight:800;margin:8px 0 14px}'
      + '.meta,.box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}.meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}'
      + '.label{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}.value{font-weight:600;margin-top:2px}'
      + 'h3{font-size:14px;margin:18px 0 8px}table{width:100%;border-collapse:collapse}th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}'
      + 'th{font-size:12px;color:var(--muted)}.totals td{padding:6px 6px}.totals .l{color:var(--muted)}.totals .r{text-align:right;font-weight:600}.grand{font-size:18px;font-weight:800}.per{font-weight:700}'
      + '@media print{.noprint{display:none}}</style>'
      + '<body><div class="wrap">'
      + '<div class="hdr">'
      + '<div class="brand"><div class="name">Pigmacast Studio\'s PressQuote Pro</div><div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div></div></div>'
      + '<div class="title">Custom Apparel Estimate</div>'
      + '<div class="meta">'
      + '<div><div class="label">Quote #</div><div class="value">'+qn+'</div></div>'
      + '<div><div class="label">Date Issued</div><div class="value">'+issued+'</div></div>'
      + '<div><div class="label">Expires</div><div class="value">'+expires+' <span style="color:#667385;font-size:12px">(14 days)</span></div></div>'
      + '<div><div class="label">Client</div><div class="value">'+clientName+' · '+clientEmail+'</div></div>'
      + '</div>'
      + '<h3>Job Summary</h3><div class="box">'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">'
      + '<div><div class="label">Project</div><div class="value">'+projectName+'</div></div>'
      + '<div><div class="label">Special Notes</div><div class="value">'+notes+'</div></div>'
      + '<div><div class="label">Garment Style / Code</div><div class="value">'+styles+' · '+codes+'</div></div>'
      + '</div>'
      + '<div style="margin-top:10px">'+tableHTML+'</div>'
      + '<div style="margin-top:10px"><table><thead><tr><th>Print Specs</th></tr></thead><tbody><tr><td>'
      + '<div><span class="label">Locations</span> <span class="value">'+p.locs+'</span></div>'
      + '<div><span class="label">Print Size(s)</span> <span class="value">'+p.psizes+'</span></div>'
      + '</td></tr></tbody></table></div></div>'
      + '<h3>Pricing</h3><div class="box"><table class="totals">'
      + '<tr><td class="l">Garments (lump sum)</td><td class="r">'+blanks+'</td></tr>'
      + '<tr><td class="l">Printing</td><td class="r">'+fmt(printing)+'</td></tr>'
      + '<tr><td class="l">Additional services</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Discounts</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Setup fees</td><td class="r">$0.00</td></tr>'
      + '<tr><td class="l">Subtotal</td><td class="r">'+fmt(parseMoney(blanks)+printing)+'</td></tr>'
      + '<tr><td class="l">Total</td><td class="r grand">'+total_client+'</td></tr>'
      + '<tr><td class="l">Per unit</td><td class="r per">'+per_unit+'</td></tr>'
      + '</table><div class="noprint" style="margin-top:10px;color:#667385">Use your browser’s “Save as PDF”.</div></div>'
      + '</div>
<script>
(function(){ 
  function fmt(n){ return '$'+Number(String(n).replace(/[^0-9.\-]/g,'' )||0).toFixed(2); }

  function gatherGarments(){ 
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{ 
      const sel=line.querySelector('.garmentSel'); 
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }

  function placementSummary(){ 
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id); 
      if(cb && cb.checked){ 
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }

  function snapshotTotals(){
    const el = (id) => { const n=(document.getElementById(id)||{}).textContent||'$0.00'; return n; };
    return {
      blanks: el('blanksAmt'),
      gang: el('gangAmt'),
      inbound: el('inboundAmt'),
      labor: el('laborAmt'),
      sub: el('subAmt'),
      total: el('clientAmt'),
      per: el('perAmt'),
      units: (document.getElementById('unitsAmt')||{}).textContent||'0'
    };
  }

  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' + 
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') + 
           '</tbody></table>';
  }

  window.PQP_export_open = function(){ 
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}}
  body{{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}}
  .wrap{{max-width:820px;margin:24px auto;padding:0 16px 28px}}
  .hdr{{display:flex;align-items:center;gap:12px;margin-bottom:10px}}
  .logo img{{width:120px;height:auto;display:block}}
  .brand .name{{font-weight:800;font-size:18px;letter-spacing:.2px}}
  .brand .contact a{{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}}
  .title{{font-size:22px;font-weight:800;margin:8px 0 14px}}
  .meta,.box{{border:1px solid var(--line);border-radius:10px;padding:10px 12px}}
  .meta{{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}}
  .label{{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}}
  .value{{font-weight:600;margin-top:2px}}
  h3{{font-size:14px;margin:18px 0 8px}}
  table{{width:100%;border-collapse:collapse}}
  th,td{{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}}
  th{{font-size:12px;color:var(--muted)}}
  .totals td{{padding:6px 6px}}
  .totals .l{{color:var(--muted)}}
  .totals .r{{text-align:right;font-weight:600}}
  .grand{{font-size:18px;font-weight:800}}
  .per{{font-weight:700}}
  .fine{{color:var(--muted);font-size:12px;margin-top:6px}}
  @media print{{body{{margin:0}}.wrap{{max-width:7.4in;margin:.2in auto;padding:0}}}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div><div class="label">Quote #</div><div class="value">QNUM</div></div>
      <div><div class="label">Date Issued</div><div class="value">ISSUED</div></div>
      <div><div class="label">Expires</div><div class="value">EXPIRES <span style="color:var(--muted);font-size:12px">(14 days)</span></div></div>
      <div><div class="label">Client</div><div class="value">CLIENT · CEMAIL</div></div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><div class="label">Project</div><div class="value">PROJECT</div></div>
        <div><div class="label">Special Notes</div><div class="value">CNOTES</div></div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> <span class="value">LOCATIONS</span></div>
                <div><span class="label">Print Size(s)</span> <span class="value">PSIZES</span></div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing</td><td class="r">P_GANG</td></tr>
        <tr><td class="l">Inbound shipping (Ninja)</td><td class="r">P_INBOUND</td></tr>
        <tr><td class="l">Labor</td><td class="r">P_LABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, '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')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_GANG/g, t.gang)
      .replace(/P_INBOUND/g, t.inbound)
      .replace(/P_LABOR/g, t.labor)
      .replace(/P_SUB/g, t.sub)
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; 
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };

  const exportBtn=document.getElementById('exportBtn');
  const exportModal=document.getElementById('exportModal');
  const exportCancel=document.getElementById('exportCancel');
  if(exportBtn && exportModal){ exportBtn.addEventListener('click', ()=> exportModal.classList.add('active')); }
  if(exportCancel){ exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active')); }
  if(exportModal){ exportModal.addEventListener('click', (e)=>{ if(e.target===exportModal) exportModal.classList.remove('active'); }); }
})();
</script>


<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body></html>';

    return html.replace('LOGO64','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');
  }

  window.PQP_DO_EXPORT = function(){
    try {
      var html = buildClientHTML();
      var iframe = document.createElement('iframe');
      iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
      iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
      iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
      document.body.appendChild(iframe);
      iframe.srcdoc = html;
      iframe.onload = function(){
        try{ var win=iframe.contentWindow; if(win){ win.focus(); win.print(); } }
        catch(e){ alert('Printing blocked. Use Save as PDF.'); }
        finally { setTimeout(function(){ iframe.remove(); }, 1500); }
      };
    } catch (e) { alert('Export failed: '+e.message); console.error(e); }
  };

  // Bind buttons idempotently
  var exportBtn = document.getElementById('exportBtn');
  if (exportBtn && !exportBtn.dataset.bound) { exportBtn.dataset.bound='1'; exportBtn.addEventListener('click', function(){ var m=document.getElementById('exportModal'); if(m) m.classList.add('active'); }); }
  var go = document.getElementById('exportGo');
  if (go && !go.dataset.bound) { go.dataset.bound='1'; go.addEventListener('click', function(){ window.PQP_DO_EXPORT(); var m=document.getElementById('exportModal'); if(m) m.classList.remove('active'); }); }
  var cancel = document.getElementById('exportCancel');
  if (cancel && !cancel.dataset.bound) { cancel.dataset.bound='1'; cancel.addEventListener('click', function(){ var m=document.getElementById('exportModal'); if(m) m.classList.remove('active'); }); }
})();
</script>


<script>
(function(){ 
  function fmt(n){ return '$'+Number(String(n).replace(/[^0-9.\-]/g,'' )||0).toFixed(2); }

  function gatherGarments(){ 
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{ 
      const sel=line.querySelector('.garmentSel'); 
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }

  function placementSummary(){ 
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id); 
      if(cb && cb.checked){ 
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }

  function snapshotTotals(){
    const el = (id) => { const n=(document.getElementById(id)||{}).textContent||'$0.00'; return n; };
    return {
      blanks: el('blanksAmt'),
      gang: el('gangAmt'),
      inbound: el('inboundAmt'),
      labor: el('laborAmt'),
      sub: el('subAmt'),
      total: el('clientAmt'),
      per: el('perAmt'),
      units: (document.getElementById('unitsAmt')||{}).textContent||'0'
    };
  }

  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' + 
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') + 
           '</tbody></table>';
  }

  window.PQP_export_open = function(){ 
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}}
  body{{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}}
  .wrap{{max-width:820px;margin:24px auto;padding:0 16px 28px}}
  .hdr{{display:flex;align-items:center;gap:12px;margin-bottom:10px}}
  .logo img{{width:120px;height:auto;display:block}}
  .brand .name{{font-weight:800;font-size:18px;letter-spacing:.2px}}
  .brand .contact a{{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}}
  .title{{font-size:22px;font-weight:800;margin:8px 0 14px}}
  .meta,.box{{border:1px solid var(--line);border-radius:10px;padding:10px 12px}}
  .meta{{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px}}
  .label{{font-size:11px;color:var(--muted);letter-spacing:.05em;text-transform:uppercase}}
  .value{{font-weight:600;margin-top:2px}}
  h3{{font-size:14px;margin:18px 0 8px}}
  table{{width:100%;border-collapse:collapse}}
  th,td{{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}}
  th{{font-size:12px;color:var(--muted)}}
  .totals td{{padding:6px 6px}}
  .totals .l{{color:var(--muted)}}
  .totals .r{{text-align:right;font-weight:600}}
  .grand{{font-size:18px;font-weight:800}}
  .per{{font-weight:700}}
  .fine{{color:var(--muted);font-size:12px;margin-top:6px}}
  @media print{{body{{margin:0}}.wrap{{max-width:7.4in;margin:.2in auto;padding:0}}}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div><div class="label">Quote #</div><div class="value">QNUM</div></div>
      <div><div class="label">Date Issued</div><div class="value">ISSUED</div></div>
      <div><div class="label">Expires</div><div class="value">EXPIRES <span style="color:var(--muted);font-size:12px">(14 days)</span></div></div>
      <div><div class="label">Client</div><div class="value">CLIENT · CEMAIL</div></div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><div class="label">Project</div><div class="value">PROJECT</div></div>
        <div><div class="label">Special Notes</div><div class="value">CNOTES</div></div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> <span class="value">LOCATIONS</span></div>
                <div><span class="label">Print Size(s)</span> <span class="value">PSIZES</span></div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing</td><td class="r">P_GANG</td></tr>
        <tr><td class="l">Inbound shipping (Ninja)</td><td class="r">P_INBOUND</td></tr>
        <tr><td class="l">Labor</td><td class="r">P_LABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, '/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAA0JCgsKCA0LCgsODg0PEyAVExISEyccHhcgLikxMC4pLSwzOko+MzZGNywtQFdBRkxOUlNSMj5aYVpQYEpRUk//2wBDAQ4ODhMREyYVFSZPNS01T09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0//wgARCACkAHgDASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAUCAwQBBv/EABkBAQADAQEAAAAAAAAAAAAAAAACAwQFAf/aAAwDAQACEAMQAAAB9HgkwFoyBaMgWjLguGQLRkC0ZYzYdBcxXMQAAAr8tpq05X2vy/pI3WAUWC5iuGIAuYrmIAAq2ednSdlDpYY68cfel6/qhvzJi5iuh4xAFzFcxDnUjzDMj0eXyEo23Q5azj0VHqZzxTFzFdRUxAFzFcxDyfo/N3Zbo9bbM2JvoMXQhPOhrucrF+rza6q52GRiBOpcxXMTCk9NGymrUIo3MUeSc+lC2V0NPNHbudRqhpzaecxAuguYrmIQnUecz6bHTzWabM1lF1s8lMLu7I55r2K7q5mIHpcxXMQKpHV+3sfcEtvctmO26bzkoR112rteP0yAFzFcxMXNgYea4lMdPCEL4nar7DPRvwDEAXMV/TeKw3dwBujjDfDGG65WDRdDIPwAAAAAAAAAAAAAA//EACYQAAEEAQQCAgIDAAAAAAAAAAIAAQMENBAREhQTICExBSMkMkD/2gAIAQEAAQUCkMYw79Vd+qu/VXfqrv1V36q79Vd+qu/VXfqrv1V36q79XS/h+3xv62yeOsr+H6mTAHMpZa8vkH0v4Sv4frbl7EqA3jMDYw1v4Sv4fpdncGEWAdK03iPW/hK/h6zzDBEDE7+lObW/hK/h6fSOTszeosTlE5PGr+Er+Hp+QldfDNqIEaipoREG0v4Sv4egl5ZtIq5SIYYxZhYdJrMUSK3MaryPIN/CV/DVkuNeFtoPt4a22ss0cIy2pZUIsyFlV/tfwlfw1dw4BcwihaPSezHApLUpvtuTMmZMyrt838JX8NELEIRiGli6mb5TMmFMyZlE2w38JX8PQiYRnsFZTCuKYUwpmTMhbd1fwlfw9JIxljKIoS4riuK2WyZkI8dL+Er+HqQsTPWcVwJcVxdNG6ZmbW/hK/hryBvybfyBycxYuY8uQ8iMQX2hJiZpBcvIG9596Kv4aHk6fdpmfx1iJxlDcZYuWwt/Ikk3hDcUDgER/Et/CV/DTMzLZuTkLHJsxE0e/KN4RLkQuJCLjItmWzO9/CV/D1IHdzDkiDcvE3hENiaL9LB+zS/hK/hyXIIz79Zd+su/WXfrLv1l36y79Zd+su/WXfrLv1lbtwyVv8H/xAAkEQACAgECBgMBAAAAAAAAAAABAgADEQQgEhMhMTJCECIwQP/aAAgBAwEBPwH877PQSs5G66zlrE6mVLGXhOwnAzGc2NmViV4Ess4tmqbCYlVZbtFQLErZzhYulVfKXAB+nzbVzMRK/VZXowPKdEGBHeWHLbKCir9YbYzx3xtBI7TmmGw/2f/EACURAAICAQMCBwEAAAAAAAAAAAECAAMREiAxBBATISIwMkBBYf/aAAgBAgEBPwH26K8+oy6rScjdWmswDEKhhgx0KHB21ppHZrUWXXeJ+bKBlozhB5x7WeAEx8LFbUM9630QksYEA5j2gS27Mo+A2G0JH6mPdmVVm1v5tZQ3MbpAeDF6NBzAABgfb//EADYQAAECAgcHAwIEBwAAAAAAAAEAAhARAxIhMTJxgSAiM1GSobETQWEEIzBCYpFAQ1JyweHx/9oACAEBAAY/Ai95k0Li9iuL2K4vYri9iuL2K4vYri9iuL2K4vYri9iuL2K4vYri9jB+nnbltPey8Qfp52i5xkAjTusnhHIK3ENmkyg/Tztek3hsxfJhWCDhsUmUH6edn0qPiP7KqI24TsUmUH6edgvd/wBRpKTG7ts+m7SNJlB+nnYr/wAtmD5+drdnP4QriToUmUH6eYt+nZe+/JSF2xuhTpToFJolGkyg/TzGkpuZkMozuapAKwQkTN39IvW6AwfuUa16pMoP08wpHcmlNyVirUl/KM6R0lJv22d1ZAqkyg/TzCl/tTA3kubucN613s0Kz/QVZxrO5nYKpMoP08wLXXFbglAs+n1ep3k3k7dJlB+nmJc4yAVVs20Xd34NJlB+nmJY8TBVR935Xc/waTKD9POxJwmCvtmzk5WtKuVyt2KTKD9PMJTQE7Sqta1VZ2qrO1VZ2reMpwm0zCkCpVrlSEQfp5hS1TI1/wDAQE5n00yUgJWklF3JgPdOrfmm5CklxDM5eypHO5CWSPpm1xqgotlujCqPekPb5VGB7kz/AGVJlB+nmBl7qfug33vuQ3Jl1miDSLSJaKscEkd2z5Vcy3SdEHAZWK5A8lSZQfp52Jg+3JN/SZoOnaAUKOd0k508SNGTfNV5+0o0mUH6eUWOcZj4WM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JWM9JT2McST+k/wAD/8QAKBAAAQIFAwUAAwEBAAAAAAAAAQARECExYfBBUaEgcbHB0YGR8eFA/9oACAEBAAE/IdVACsHyWD5LB8lg+SwfJYPksHyWD5LB8lg+SwfJYPksHyQIIcUKwrEw2TDZMNkw2TDZMNk+gfZMNkw2TDZMNkw2R+ABSLPrDCs6mczclB2lBBJ7i9+ngvIhhWdU4p03EigSqOVSxPRwXkQwrOkbLtW7ob0dd0UVID37XVaR4LyIYVnRpB0G7ZTD55s2RRRg/PmK/UeC8iGFZEkASSwCM/rMG5CUUUYADSGiEzfhDgvIhhWRMBDTz2UAMTAGCMKyCIMUoOC/KbDC0eC8iGFZF6/UkUVO3eOq12ak1KpQIFf2xQhlj8KRBh0XBeRDCsgx1WH6TV7kAQAHJ0QWTP0CLQgaDU9k+u2q/ipD/YEgbLgvIhhWQB2NyAk5IoW/cgEMTlwVJkA49ynOMiHI9MrLgvIhhWQEw4WIsgbBC0CEsiRLQHbdMkRO6BKA6WyebrgvIhhWRBgCckp+4T/gmAwDBDpAjIAgGAA0XBeRDCsi0Mc0BzTlo2HYoKECBQhSWATS8OC8iGFZ0E4lQCKrUP8AS7FAVFynDV+kDUJWBDZCPBeRDCsgQGQuJGyp0w4CmGCFQNEAED6BaHbotLNDsmhnQG6BAOKJvDcCJhSRIsiImHJjZAMHDe4YVkBIItQQ6AEGJsTqXCE8Tpo0mbl1LmSUbarhGGZXGwYDhHpIr7SY3ot4AAjp/SC8j3OOo7T/AEhLJDH4BCIUocGLqIiWMGAapwXkQwrIFCBnOblaSJGeyPEPpBzXRbyvyTCzsA35ekZTPdMaIz9ogMQmXQgEQ0OjHCfElUWSQEzBKkkTAATQdlwXkQwrOgyBBLKDqnJu2LymOaEEt/4qjMIA9v4nuIkn7IE0Cce5P1MERkkGaCPBeRDCsQGSsHlZJ6WSelknpZJ6WSelknpZJ6WSelknpZJ6WSekHAchc/4f/9oADAMBAAIAAwAAABBzzzjzzjCgADIEBQCgAuQeFQChaBK/BQCgMkC/PYCj+QKVZ8ChBVoSPYCgRdvoVgCiiCQTzQCAwywyxgAAAAAAAAD/xAAiEQEAAgIBAgcAAAAAAAAAAAABABEhMSAQQTBAUWGBkaH/2gAIAQMBAT8Q8PL9kUb3yGzu6gbHbLiolDwBFojF/EyxDbAIBrg1DuxiDMSrFwW3b+RUadcAuBjNDCrdsGo0SyXLwu+zt79K2Vvfi7anrxWoq5fN/wD/xAAgEQEAAgIBBAMAAAAAAAAAAAABABEgITEQQVGRMEDR/9oACAECAQE/EPjveieKHJae0IURjxMc4QK0Qq4QW1gUCle8N74l8jWOjxEdSjvnCG01uWZ2wC4BoliBGe+8BK6DxunDn8gAUYAULi2wiltZWij7f//EACkQAQACAQMEAgICAgMAAAAAAAEAESExQWEQUYGRIHGhwbHh0fAwQPH/2gAIAQEAAT8QCmUXFq2tDOrOJBxIOJBxIOJBxIOJBxIOJBxIOJBxIOJATawsemHA9TgepwPU4HqcD1OB6iISWWYXWl/mcD1OB6nA9TgepwPUGQ9Y0wNHG8NPngcxB2wRUaufVLZ5XMK0K6P4fJCNPngq2xpuA0+p/PiUCgoNAjj5cmw3GMnZ6bjuPPxhGnywx/mkeV9uP6mlZqWq3WOKLqQrm/1mCAUI5E+EI0+OCXWGjcpoPuJtb/hD2DEXUZSMUzbn+sfCEafDAywLVaAmRVhvkR/H/vSUXQwgdBoVHviPPopkzzjv26wjT4YIlwFta+6fT3laog7EUWNoBV0DKx4puijV4787EBVh1sx5/wAIJJ9jXwhGnXBaLYuWi8eA/UcUoL02s/Q/cdlaVlfY9uIQlxrR0tW2wu+zbzUfG21P6npjndtlFJj99IRp1wVxSX2tUILezy3EiKoBasqyaxr+zu/iBRRFAtQDvLDBjWXsDKzLGd2Pl/XPMwoltrqruu80cQO0JfT/AH0hGnXBg6rPU8VsAVq8TfsMhpwdjoBSfd+LY5Zqx+D/AGebQ2DWWxOpa0OwbHBEU45XtKOBPz0hGnXCzbvfIpI3bqwKwYD6igWtBHZyxL4+9zp9yw/rVb5YrLGcE4JXtLl7/wAHSEafDC5GhqAi2Sq/Z7cN4RmDABpGdpwyraccpj76/EM1QKOkI0+GGLEg/hORzGRsYFdj+B32nFD7Tjle0M2gK0u0PLl6vWEafHAD/VbA5IzfZWX6aocN+JikOKHshrg8p+qUdlA9spH3O78IRp1wvWugttV0+EiLbpbyhq/UxRVWRbs1p5gGw3updXBWEK05TF57YgiDERcg6L6ZltKmcrg1YZe1pMn6qyx8xo/0ZA7i6XxLZNALbdmt5bKDT4w064OciLwN6hIuI+LJ0L9sv2hVI1YMp5WwAlBBqidWd0qzKtMDZ/0vzGAVlIW0Mt2BjywCk4nBWu12v6O0D1ky6WpTcyYxDApsKLRSUN0Ua95YyaqWVYa23n2xkT3AMznvnpCNOuAIVdnYC3wHqLh1Ud9m69hEiuVVRdWaxm/zAbL3VgybPbXG6xDsvk3hRdiHijNKHbjX68Qlco4UrRExWMSnnD2AkbQ2G9tYMto2yVuXmmiJIOWAxetR65q2timvHSEafHADiDdSrXnL9aGs1EgOLvCVD7nQhgZ8ImKWQS22IvkSjldKoAUB/mBXVoFNM/EOdJSAAqv2r8IRpApArsCCC1ADFl6hW/8AyBAgQIECBAgQIEH9QYLaOqcQ0P8Aof/Z')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_GANG/g, t.gang)
      .replace(/P_INBOUND/g, t.inbound)
      .replace(/P_LABOR/g, t.labor)
      .replace(/P_SUB/g, t.sub)
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; 
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };

  const exportBtn=document.getElementById('exportBtn');
  const exportModal=document.getElementById('exportModal');
  const exportCancel=document.getElementById('exportCancel');
  if(exportBtn && exportModal){ exportBtn.addEventListener('click', ()=> exportModal.classList.add('active')); }
  if(exportCancel){ exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active')); }
  if(exportModal){ exportModal.addEventListener('click', (e)=>{ if(e.target===exportModal) exportModal.classList.remove('active'); }); }
})();
</script>


<script>
(function(){
  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push(inp.dataset.size+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  window.PQP_export_open = function(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = `<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .logo img{width:120px;height:auto;display:block}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5} .brand{ text-align:center; width:100%; }
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>

<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

</body>
</html>`
      .replace(/EM_LOGO/g, 'LOGO64')
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  };
})();
</script>


<script>
(function(){
  // Guard: if an export is already defined and working, don't double-bind.
  if (window.__PQP_EXPORT_PATCH_APPLIED__) return;
  window.__PQP_EXPORT_PATCH_APPLIED__ = true;

  function moneyToNum(s){ return Number(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function fmt(n){ return '$'+Number(n||0).toFixed(2); }

  function gatherGarments(){
    const out=[];
    document.querySelectorAll('.garment-line').forEach(line=>{
      const sel=line.querySelector('.garmentSel');
      if(!sel||!sel.value) return;
      let units=0; const parts=[];
      line.querySelectorAll('.qty').forEach(inp=>{ const n=parseInt(inp.value||'0'); if(n>0){ units+=n; parts.push((inp.dataset.size||inp.name||'')+'×'+n); } });
      if(units>0) out.push({label: sel.options[sel.selectedIndex].text, parts: parts.join(', '), units});
    });
    return out;
  }
  function buildRowsHTML(rows){
    if(!rows.length) return '—';
    return '<table><thead><tr><th>Garment</th><th>Sizes &amp; Quantities</th><th>Total</th></tr></thead><tbody>' +
           rows.map(r=>'<tr><td>'+r.label+'</td><td>'+r.parts+'</td><td>'+r.units+'</td></tr>').join('') +
           '</tbody></table>';
  }
  function placementSummary(){
    function v(id){ const el=document.getElementById(id); return el?el.value:''; }
    const entries=[]; const sizes=[];
    [['pl_left','Left chest'],['pl_front','Full front'],['pl_back','Full back'],['pl_sleeve','Sleeve']].forEach(([id,lab])=>{
      const cb=document.getElementById(id);
      if(cb && cb.checked){
        entries.push(lab);
        const w=v(id+'_w'), h=v(id+'_h');
        if(Number(w)>0 && Number(h)>0) sizes.push(lab+' '+w+'″×'+h+'″');
      }
    });
    return { locs: entries.join(', ')||'—', psizes: sizes.join('; ')||'—' };
  }
  function snapshotTotals(){
    const t = (id) => (document.getElementById(id)||{}).textContent||'$0.00';
    return {
      blanks: t('blanksAmt'),
      gang: t('gangAmt'),
      labor: t('laborAmt'),
      total: t('clientAmt'),
      per: t('perAmt')
    };
  }

  function templateHTML(){
    return String.raw`<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Custom Apparel Estimate — PressQuote Pro</title>
<style>
  :root{--ink:#0e1116;--muted:#667385;--line:#e8ecf2}
  body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px 28px}
  .hdr{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
  .brand .name{font-weight:800;font-size:18px;letter-spacing:.2px;text-align:center}
  .brand{ text-align:center; width:100%; }
  .brand .contact a{color:inherit;text-decoration:none;border-bottom:1px solid #dcdfe5}
  .title{font-size:22px;font-weight:800;margin:8px 0 14px}
  .meta{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
  .line{font-weight:600}
  .line .label{color:var(--muted);font-weight:700;margin-right:8px;letter-spacing:.03em;text-transform:uppercase;font-size:11px}
  .muted{color:var(--muted);font-size:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  h3{font-size:14px;margin:18px 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .totals td{padding:6px 6px}
  .totals .l{color:var(--muted)}
  .totals .r{text-align:right;font-weight:600}
  .grand{font-size:18px;font-weight:800}
  .per{font-weight:700}
  .fine{color:var(--muted);font-size:12px;margin-top:6px}
  @media print{body{margin:0}.wrap{max-width:7.4in;margin:.2in auto;padding:0}}
</style>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="name">Pigmacast Studio's PressQuote Pro</div>
        <div class="contact"><a href="mailto:info@pigmacast.com">info@pigmacast.com</a> · <a href="https://www.pigmacast.com">www.pigmacast.com</a></div>
      </div>
    </div>

    <div class="title">Custom Apparel Estimate</div>

    <div class="meta">
      <div class="line"><span class="label">Quote #</span> QNUM</div>
      <div class="line"><span class="label">Date Issued</span> ISSUED</div>
      <div class="line"><span class="label">Expires</span> EXPIRES <span class="muted">(14 days)</span></div>
      <div class="line"><span class="label">Client</span> CLIENT · CEMAIL</div>
    </div>

    <h3>Job Summary</h3>
    <div class="box">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 14px">
        <div><span class="label">Project</span> PROJECT</div>
        <div><span class="label">Special Notes</span> CNOTES</div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Garments</th><th>Print Specs</th></tr></thead>
          <tbody><tr>
            <td>GARMENT_ROWS</td>
            <td><div><span class="label">Locations</span> LOCATIONS</div>
                <div><span class="label">Print Size(s)</span> PSIZES</div></td>
          </tr></tbody>
        </table>
      </div>
    </div>

    <h3>Pricing</h3>
    <div class="box">
      <table class="totals">
        <tr><td class="l">Garments (lump sum)</td><td class="r">P_BLANKS</td></tr>
        <tr><td class="l">Printing &amp; Labor</td><td class="r">P_PRINTLABOR</td></tr>
        <tr><td class="l">Subtotal</td><td class="r">P_SUB_MERGED</td></tr>
        <tr><td class="l"><strong>Total</strong></td><td class="r grand">P_TOTAL</td></tr>
        <tr><td class="l">Per unit</td><td class="r per">P_PER</td></tr>
      </table>
      <div class="fine">Shipping &amp; handling not included in this quote. All variables are subject to change.</div>
    </div>
  </div>
</body>
</html>`;
  }

  function buildAndPrint(){
    const now=new Date();
    const qnum = 'PQP-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    const issued = now.toLocaleDateString();
    const expires = new Date(now.getTime()+14*86400000).toLocaleDateString();

    const client = (document.getElementById('ex_client_name')||{}).value || '—';
    const email  = (document.getElementById('ex_client_email')||{}).value || '—';
    const project= (document.getElementById('ex_project_name')||{}).value || '—';
    const notes  = (document.getElementById('ex_notes')||{}).value || '—';

    const rows = gatherGarments();
    const p = placementSummary();
    const t = snapshotTotals();

    const blanksN = moneyToNum(t.blanks);
    const printN  = moneyToNum(t.gang);
    const laborN  = moneyToNum(t.labor);
    const printLabor = printN + laborN;
    const subMerged  = blanksN + printLabor;

    var html = templateHTML()
      .replace(/QNUM/g, qnum)
      .replace(/ISSUED/g, issued)
      .replace(/EXPIRES/g, expires)
      .replace(/CLIENT/g, client)
      .replace(/CEMAIL/g, email)
      .replace(/PROJECT/g, project)
      .replace(/CNOTES/g, notes)
      .replace(/GARMENT_ROWS/g, buildRowsHTML(rows))
      .replace(/LOCATIONS/g, p.locs)
      .replace(/PSIZES/g, p.psizes)
      .replace(/P_BLANKS/g, t.blanks)
      .replace(/P_PRINTLABOR/g, fmt(printLabor))
      .replace(/P_SUB_MERGED/g, fmt(subMerged))
      .replace(/P_TOTAL/g, t.total)
      .replace(/P_PER/g, t.per);

    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.setAttribute('sandbox','allow-modals allow-same-origin allow-scripts');
    document.body.appendChild(iframe);
    iframe.srcdoc = html;
    iframe.onload = function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Use your browser’s “Save as PDF”.'); } setTimeout(()=>iframe.remove(),1500); };
  }

  // Public hook
  window.PQP_DO_EXPORT = buildAndPrint;

  // Wire up modal buttons safely
  function bind(){
    const exportBtn = document.getElementById('exportBtn') || document.querySelector('[data-export-btn]');
    const exportModal = document.getElementById('exportModal');
    const exportCancel = document.getElementById('exportCancel');
    const exportGo = document.getElementById('exportGo') || document.querySelector('[data-export-go]');

    if (exportBtn && exportModal){
      exportBtn.addEventListener('click', ()=> exportModal.classList.add('active'));
    }
    if (exportCancel && exportModal){
      exportCancel.addEventListener('click', ()=> exportModal.classList.remove('active'));
    }
    if (exportGo && exportModal){
      exportGo.addEventListener('click', ()=>{ exportModal.classList.remove('active'); buildAndPrint(); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>


  <!-- Youth Size Chart Modal (inches only) -->
  <div class="modal" id="youthChartModal" aria-hidden="true">
    <div class="sheet">
      <div class="row between" style="margin-bottom:12px">
        <div><strong>General Youth Size Chart (inches)</strong></div>
        <div><button class="btn ghost" id="ycClose" type="button">Close</button></div>
      </div>
      <div class="price-wrap">
        <div class="price-grid" style="grid-template-columns:repeat(7,1fr)">
          <div class="hdr">Size</div><div class="hdr">Numeric</div><div class="hdr">Age</div>
          <div class="hdr">Height (in)</div><div class="hdr">Chest (in)</div><div class="hdr">Waist (in)</div><div class="hdr">Hips (in)</div>
          <div class="box">XS</div><div class="box">5–6</div><div class="box">5–6</div><div class="box">42–47</div><div class="box">24–25</div><div class="box">22–23</div><div class="box">25–26</div>
          <div class="box">S</div><div class="box">6–7</div><div class="box">6–7</div><div class="box">47–52</div><div class="box">25–27</div><div class="box">23–24</div><div class="box">26–28</div>
          <div class="box">M</div><div class="box">8–10</div><div class="box">8–10</div><div class="box">52–57</div><div class="box">27–30</div><div class="box">24–26</div><div class="box">28–31</div>
          <div class="box">L</div><div class="box">12–14</div><div class="box">12–14</div><div class="box">57–62</div><div class="box">30–33</div><div class="box">26–28</div><div class="box">31–34</div>
          <div class="box">XL</div><div class="box">16–18</div><div class="box">16–18</div><div class="box">62–67</div><div class="box">33–36</div><div class="box">28–30</div><div class="box">34–36</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  if (window.__g500bHardBaked) return; window.__g500bHardBaked = true;
  function addYouthChartButton(){
    const header = document.querySelector('#garments .row.between');
    if (!header || document.getElementById('youthChartBtn')) return;
    const btn = document.createElement('button');
    btn.className='btn ghost'; btn.id='youthChartBtn'; btn.type='button'; btn.textContent='Youth Size Chart';
    header.insertBefore(btn, header.firstChild);
    btn.addEventListener('click', ()=> document.getElementById('youthChartModal')?.classList.add('active'));
    document.getElementById('ycClose')?.addEventListener('click', ()=> document.getElementById('youthChartModal')?.classList.remove('active'));
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', ()=>{ addYouthChartButton(); if (typeof rebuildAllGarmentLabels==='function') rebuildAllGarmentLabels(); });
  else { addYouthChartButton(); if (typeof rebuildAllGarmentLabels==='function') rebuildAllGarmentLabels(); }
})();
</script>


<script>
(function(){
  var btn = document.getElementById('youthChartBtn');
  var modal = document.getElementById('youthChartModal');
  var close = document.getElementById('ycClose');
  if (btn && modal){
    btn.addEventListener('click', function(){
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
    });
    var hide = function(){
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
    };
    if (close) close.addEventListener('click', hide);
    modal.addEventListener('click', function(e){ if (e.target === modal) hide(); });
  }
})();
</script>


<script>
(function(){
  if (window.__youthSectionV4) return; window.__youthSectionV4 = true;

  function youthCols(){ return "120px 1fr 90px repeat(5, minmax(70px, 1fr))"; }

  function buildYouthSection(){
    const editor = document.getElementById('priceEditor');
    if (!editor) return;
    // Clean up any prior section
    editor.querySelectorAll('.youth-section').forEach(n=>n.remove());

    // Find the original G500B row among built rows
    const rows = Array.from(editor.querySelectorAll('.price-grid'));
    const gRow = rows.find(r => {
      const sku = (r.querySelector('input.sku')?.value||"").trim().toUpperCase();
      const name = (r.querySelector('input[type="text"]')?.value||"");
      return sku === "G500B" || /Gildan\s+G500B\s+Youth/i.test(name);
    });
    if (!gRow) return;

    // Pull prices from PRICING
    let priceMap = {};
    try{
      const rec = (window.PRICING?.garments||[]).find(g=>g.sku==="G500B");
      priceMap = rec?.size_prices || {};
    }catch(e){}

    // Title
    const title = document.createElement('div');
    title.className = 'sub youth-section';
    title.textContent = 'Youth Garments';
    title.style.margin = '12px 0 6px';

    // Header
    const hdr = document.createElement('div');
    hdr.className = 'price-grid youth-section youth-header';
    hdr.style.gridTemplateColumns = youthCols();
    hdr.innerHTML = '<div class="hdr">Garment</div><div class="hdr">Name</div><div class="hdr">SKU</div>' +
                    '<div class="hdr">XS</div><div class="hdr">S</div><div class="hdr">M</div><div class="hdr">L</div><div class="hdr">XL</div>';

    // Row
    const row = document.createElement('div');
    row.className = 'price-grid youth-section youth-row';
    row.style.gridTemplateColumns = youthCols();

    // Cell 1: actions incl. Delete (marks row deleted, matching app pattern)
    const actions = document.createElement('div');
    const wrap = document.createElement('div'); wrap.className = 'inline-actions';
    const del = document.createElement('button'); del.className='btn ghost'; del.type='button'; del.textContent='Delete';
    del.addEventListener('click', () => { row.dataset.deleted = row.dataset.deleted === '1' ? '0' : '1'; row.classList.toggle('muted'); });
    wrap.appendChild(del); actions.appendChild(wrap); row.appendChild(actions);

    // Cell 2: name
    const nameCell = document.createElement('div');
    const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.className='name';
    nameInput.value = 'Gildan G500B Youth Heavy Cotton T-Shirt';
    nameCell.appendChild(nameInput); row.appendChild(nameCell);

    // Cell 3: sku
    const skuCell = document.createElement('div');
    const skuInput = document.createElement('input'); skuInput.type='text'; skuInput.className='sku'; skuInput.value='G500B';
    skuCell.appendChild(skuInput); row.appendChild(skuCell);

    // Cells 4-8: XS..XL
    ['XS','S','M','L','XL'].forEach(sz => {
      const cell = document.createElement('div');
      const inp = document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.min='0';
      inp.setAttribute('data-size', sz);
      if (priceMap && priceMap[sz] != null) inp.value = priceMap[sz];
      cell.appendChild(inp); row.appendChild(cell);
    });

    // Insert the youth block at the end and hide original G500B row
    editor.appendChild(title); editor.appendChild(hdr); editor.appendChild(row);
    gRow.style.display = 'none';
  }

  const _rebuild = window.rebuildPriceEditor;
  if (typeof _rebuild === 'function'){
    window.rebuildPriceEditor = function(){
      _rebuild();
      setTimeout(buildYouthSection, 0);
    };
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    if (document.getElementById('priceEditor')) setTimeout(buildYouthSection, 0);
  });
})();
</script>

</body>
</html>